*&---------------------------------------------------------------------*
*& Module Pool      SAPMZESS0703
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*

INCLUDE SAPMZESS0707_TOP.
*INCLUDE sapmzess0703_top                        .  " Global Data
INCLUDE SAPMZESS0707_C01.
*INCLUDE sapmzess0703_c01                        .  " Event Class
INCLUDE SAPMZESS0707_O01.
*INCLUDE sapmzess0703_o01                        .  " PBO-Modules
INCLUDE SAPMZESS0707_I01.
*INCLUDE sapmzess0703_i01                        .  " PAI-Modules
INCLUDE SAPMZESS0707_F01.
*INCLUDE sapmzess0703_f01                        .  " FORM-Routines


LOAD-OF-PROGRAM.

  "초기 구매오더코드 조건에  default 값 대입.
  PERFORM init_sel_cond USING    zsess24001-prhid
                        CHANGING zsess24002-prhid_b
                                 zsess24002-prhid_e.
                                 


#Screen 100************************************************************************************************
PROCESS BEFORE OUTPUT.
*TABSTRIP 설정
  MODULE MYTAB_ACTIVE_TAB_SET.
  CALL SUBSCREEN MYTAB_SCA INCLUDING G_MYTAB-PROG G_MYTAB-SUBSCREEN.

  MODULE status_0100.
  MODULE set_layo_fcat. "fieldcatelog 커스텀마이징.
  MODULE set_display.   "전처리 작업 + container, alv_grid 생성
*
PROCESS AFTER INPUT.


*TABSTRIP 설정마다 작동.
  CALL SUBSCREEN MYTAB_SCA.
  MODULE MYTAB_ACTIVE_TAB_GET.

  MODULE exit AT EXIT-COMMAND.
  MODULE user_command_0100.
  *************************************************************************************************************
  #Screen 200
  
  PROCESS BEFORE OUTPUT.
  MODULE status_0200.
  MODULE set_layo_fcat_200.  "fieldcatelog 커스텀마이징.
  MODULE set_display_200.    "전처리 작업 + container, alv_grid 생성

PROCESS AFTER INPUT.
  MODULE user_command_0200.
  MODULE exit_0200 AT EXIT-COMMAND.

**만약 오류가 있다면 여기!.
*PROCESS ON HELP-REQUEST.
*  FIELD ZSESS24001-PRHID WITH '0200'.
  *************************************************************************************************************
# Screen 300
  PROCESS BEFORE OUTPUT.
 MODULE STATUS_0300.
 MODULE set_display_300.
 MODULE before_each_0300.

PROCESS AFTER INPUT.
 MODULE USER_COMMAND_0300.
 MODULE exit_0300 at EXIT-COMMAND.


PROCESS ON VALUE-REQUEST.
  FIELD : ZSESS23001-PRDID MODULE f4_PRDID.
  field : zsess23001-EMPID MODULE f4_EMPID.
    *************************************************************************************************************
# Screen 301
PROCESS BEFORE OUTPUT.
 MODULE STATUS_0301.
 MODULE Before_each_300.

PROCESS AFTER INPUT.
 MODULE USER_COMMAND_0301.
 MODULE exit_0301 at EXIT-COMMAND.
 
 # PROCESS BEFORE OUTPUT.
 MODULE STATUS_0400.
 MODULE set_beforeeach_400.
*
PROCESS AFTER INPUT.
 MODULE USER_COMMAND_0400.
*************************************************************************************************************
#Screen 401

PROCESS BEFORE OUTPUT.
 MODULE STATUS_0401.
 MODULE bf_layout_401.

PROCESS AFTER INPUT.
 MODULE USER_COMMAND_0401.
 MODULE exit_0400 at EXIT-COMMAND.

*************************************************************************************************************   
#Screen 500

PROCESS BEFORE OUTPUT.
 MODULE STATUS_0500.
* MODULE beforeeach_500.
 MODULE init_tree.
 MODULE init_con.
*
PROCESS AFTER INPUT.
 MODULE EXIT_0500 AT EXIT-COMMAND.
 MODULE USER_COMMAND_0500.
 *************************************************************************************************************
 
 
 #SAPMZESS0707_C01
 *&---------------------------------------------------------------------*
*& Include          SAPMZESS0703_C01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Class lcl_event_handler
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
CLASS lcl_event_handler DEFINITION FINAL.
  PUBLIC SECTION.
    METHODS :
      handle_double_click FOR EVENT double_click OF cl_gui_alv_grid
        IMPORTING
          e_column
          e_row.

ENDCLASS.
CLASS lcl_event_receiver DEFINITION.
  PUBLIC SECTION.
    METHODS : handle_double_click
      FOR EVENT double_click OF cl_gui_alv_grid
      IMPORTING e_row e_column.


    METHODS : handle_toolbar
      FOR EVENT toolbar OF cl_gui_alv_grid
      IMPORTING e_object e_interactive.

    METHODS : handle_command
      FOR EVENT user_command OF cl_gui_alv_grid
      IMPORTING e_ucomm.

ENDCLASS.
CLASS lcl_application DEFINITION.
  PUBLIC SECTION.
    METHODS:
      handle_node_double_click FOR EVENT node_double_click OF cl_gui_simple_tree
        IMPORTING node_key.
ENDCLASS.
*&---------------------------------------------------------------------*
*& Class (Implementation) lcl_event_handler
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
CLASS lcl_event_handler IMPLEMENTATION.
  METHOD handle_double_click.
    PERFORM handle_double_click USING e_column
                                      e_row.
  ENDMETHOD.
ENDCLASS.

CLASS lcl_application IMPLEMENTATION.
  METHOD handle_node_double_click.

    SELECT a~prhid a~pntid a~empid a~title a~prdat a~crtdm a~totlp a~currc a~odchk b~pntnm c~empna
      INTO CORRESPONDING FIELDS OF TABLE gt_order_tree
      FROM ztess2401 AS a
      INNER JOIN ztess2501 AS b "구매오더 table 의 공장코드(pntid)를 통해 위탁공장의 이름(pntnm)을 가져온다.
      ON a~pntid = b~pntid
      INNER JOIN ztess0301 AS c "구매오더 table 의 사원코드(empid)를 통해 사원 이름(empid)을 가져온다.
      ON a~empid = c~empid
      WHERE a~pntid = node_key.

    PERFORM refresh_grid.
  ENDMETHOD.
ENDCLASS.

CLASS lcl_event_receiver IMPLEMENTATION.

  METHOD handle_double_click.
    LEAVE TO SCREEN 0.
  ENDMETHOD.                           "handle_double_click

*-- Add ToolBar
  METHOD handle_toolbar.
    DATA: ls_toolbar  TYPE stb_button.

    CLEAR ls_toolbar.
    ls_toolbar-butn_type = 3.
    APPEND ls_toolbar    TO e_object->mt_toolbar.

    CLEAR ls_toolbar.
    ls_toolbar-function  = 'RESH'.
    ls_toolbar-icon      = icon_refresh.
    ls_toolbar-quickinfo = 'Refresh'.
    ls_toolbar-text      = ' '.
    ls_toolbar-disabled  = ' '.
    APPEND ls_toolbar    TO e_object->mt_toolbar.
  ENDMETHOD.                    "handle_toolbar

  METHOD handle_command.
    CASE e_ucomm.
*-  REFRESH
      WHEN 'RESH'.
        SELECT a~prhid a~pntid a~empid a~title a~prdat a~crtdm a~totlp a~currc a~odchk b~pntnm c~empna
          INTO CORRESPONDING FIELDS OF TABLE gt_order_tree
          FROM ztess2401 AS a
          INNER JOIN ztess2501 AS b "구매오더 table 의 공장코드(pntid)를 통해 위탁공장의 이름(pntnm)을 가져온다.
          ON a~pntid = b~pntid
          INNER JOIN ztess0301 AS c "구매오더 table 의 사원코드(empid)를 통해 사원 이름(empid)을 가져온다.
          ON a~empid = c~empid.

        PERFORM refresh_grid.

    ENDCASE.
  ENDMETHOD.                    "handle_user_command
ENDCLASS.

#SAPMZESS0707_O01
*&---------------------------------------------------------------------*
*& Include          SAPMZESS0703_O01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Module STATUS_0100 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_0100 OUTPUT.

  DATA: fcode TYPE STANDARD TABLE OF sy-ucomm.
  APPEND 'DETAIL' TO fcode.
  APPEND 'EDIT'   TO fcode.

  IF gi_return IS INITIAL. "Condition of display or Hide

    SET PF-STATUS 'S0100' EXCLUDING fcode.
  ELSE.
    SET PF-STATUS 'S0100'.
  ENDIF.

  SET TITLEBAR 'T0100'.
ENDMODULE.
*&---------------------------------------------------------------------*
*& Module SET_LAYO_FCAT OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE set_layo_fcat OUTPUT.

  IF gt_fcat IS INITIAL.
    PERFORM set_fcat_layout.

  ENDIF.


ENDMODULE.
*&---------------------------------------------------------------------*
*& Module SET_DISPLAY OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE set_display OUTPUT.

  PERFORM set_beforeEach_0100.

  "Screen 100번 container setting
  PERFORM set_container_100.

  "Screen 100번 alv_grid setting
  PERFORM set_alv_grid_100.

*  Screen 100번 gcl_alv_grid->set_table_for_first_display
  PERFORM set_first_display_100.



ENDMODULE.
*&---------------------------------------------------------------------*
*& Form set_container_100
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_container_100 .

*container 생성
  IF gcl_container IS NOT BOUND.
    CREATE OBJECT gcl_container
      EXPORTING
*       parent                      =                  " Parent container
        container_name              = 'CON1'                 " Name of the Screen CustCtrl Name to Link Container To
*       style                       =                  " Windows Style Attributes Applied to this Container
*       lifetime                    = lifetime_default " Lifetime
*       repid                       =                  " Screen to Which this Container is Linked
*       dynnr                       =                  " Report To Which this Container is Linked
*       no_autodef_progid_dynnr     =                  " Don't Autodefined Progid and Dynnr?
      EXCEPTIONS
        cntl_error                  = 1                " CNTL_ERROR
        cntl_system_error           = 2                " CNTL_SYSTEM_ERROR
        create_error                = 3                " CREATE_ERROR
        lifetime_error              = 4                " LIFETIME_ERROR
        lifetime_dynpro_dynpro_link = 5                " LIFETIME_DYNPRO_DYNPRO_LINK
        OTHERS                      = 6.
    IF sy-subrc <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Module STATUS_0200 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_0200 OUTPUT.
  SET PF-STATUS 'S0200'.
  SET TITLEBAR 'T0200'.
ENDMODULE.
*&---------------------------------------------------------------------*
*& Module SET_LAYO_FCAT_200 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE set_layo_fcat_200 OUTPUT.
  IF gt_fcat200 IS INITIAL.
    PERFORM set_fcat_layout_200.

  ENDIF.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Module SET_DISPLAY_200 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE set_display_200 OUTPUT.

* ALV 전처리 data Setting. //todo perform 전체 생성 .

*구매오더코드를 Screen에서 1개 받아와서, 종속된 구매오더상세코드들을 pt_orderdetail에 넣는  sql.
  PERFORM set_prhid_data USING      zsess24001-prhid
                                    gs_orderdetail
                         CHANGING   gt_orderdetail.

* 전처리 단계
  PERFORM beforeeach_0200.
  "Screen 200번 container setting
  PERFORM set_container_200.

  "Screen 200번 alv_grid setting
  PERFORM set_alv_grid_200.

*  Screen 200번 gcl_alv_grid->set_table_for_first_display
  PERFORM set_first_display_200.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Module STATUS_0300 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_0300 OUTPUT.
  SET PF-STATUS 'S0300'.
  SET TITLEBAR 'T0300'.
ENDMODULE.
*&---------------------------------------------------------------------*
*& Module SET_DISPLAY_300 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE set_display_300 OUTPUT.

* ALV SETTING은 200번 Screen을 공유한다.
  "Screen 200번 container setting
  PERFORM set_container_200.

  "Screen 200번 alv_grid setting
  PERFORM set_alv_grid_200.

*  Screen 200번 gcl_alv_grid->set_table_for_first_display
  PERFORM set_first_display_200.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Module STATUS_0301 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_0301 OUTPUT.
  SET PF-STATUS 'S0301'.
  SET TITLEBAR 'T0301'.
ENDMODULE.
*&---------------------------------------------------------------------*
*& Module BEFORE_EACH OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE before_each OUTPUT.


*perform 처리 예정. => save하기 전에 채번하는 것이 원칙이다.
* 구매오더 코드 자동 채번 알고리즘. "모듈안에서 선언되는 변수는 global로 선언.
  CLEAR : zsess24003.

  DATA:
    lv_year(4)  TYPE i, "년수 ex) 2020 , 2021, 2022 지금년도.
    lv_char(8)  TYPE n, "뒤에 일련번호
    lv_full(14) TYPE c. "전체 코드 == 결과 코드

  DATA :
    lv_vdata(14) TYPE c, "(비교대상) DB에 있는 최고 구매코드
    lv_vnow(4)   TYPE c. "(비교대상) 지금 년도.


  DATA : lv_data TYPE ztess2401-prhid.
  CLEAR : gv_id, lv_year,  lv_char, lv_full, lv_vdata, lv_vnow.

  SELECT SINGLE MAX( prhid )
  INTO  lv_data
  FROM ztess2401.

  MOVE sy-datum(4) TO lv_year.
  MOVE lv_data+6(8) TO lv_char. " 여기까지 채번의 최고숫자 입력 0000 0095.

  MOVE lv_data TO lv_vdata. " LV_VdATA = 최고 구매오더코드"

  lv_vnow = lv_year.

  IF lv_vdata+2(4) EQ lv_vnow. " 현제db yymmdd = 지금 yymmdd

    lv_char += 1.
    lv_full = 'PO' && lv_year && lv_char.
    gv_id = lv_full. " 자동 채번 번호 될 예정.

    zsess24003-prhid = gv_id.

  ELSE.
    CLEAR : lv_char.
    lv_char += 1.
    lv_full = 'PO' && lv_year && lv_char.
    gv_id = lv_full. " 자동 채번 될 예정.
    zsess24003-prhid = gv_id.

  ENDIF.


  zsess24003-crtdm = sy-datum.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Module BEFORE_EACH_300 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE before_each_300 OUTPUT.

  PERFORM set_crtdm USING     zsess24003-crtdm
                    CHANGING  zsess24003-crtdm.

ENDMODULE.



*&SPWIZARD: OUTPUT MODULE FOR TS 'MYTAB'. DO NOT CHANGE THIS LINE!
*&SPWIZARD: SETS ACTIVE TAB
MODULE mytab_active_tab_set OUTPUT.

  mytab-activetab = g_mytab-pressed_tab.

  CASE g_mytab-pressed_tab.
    WHEN c_mytab-tab1.
      g_mytab-subscreen = '0107'.
    WHEN c_mytab-tab2.
      g_mytab-subscreen = '0108'.
    WHEN c_mytab-tab3.
      g_mytab-subscreen = '0109'.
    WHEN OTHERS.
*&SPWIZARD:      DO NOTHING
  ENDCASE.
ENDMODULE.
*&---------------------------------------------------------------------*
*& Module BF_LAYOUT_401 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE bf_layout_401 OUTPUT.

* 공장코드를 가지고 공장 이름을 가져오는 로직.
  PERFORM set_pntnm  USING    zsess24004-pntid
                     CHANGING zsess24004-pntnm.
*사원코드를 가지고 사원 이름을 가져오는 로직.
  PERFORM set_empid  USING    zsess24004-empid
                     CHANGING zsess24004-empna.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Module STATUS_0401 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_0401 OUTPUT.
  SET PF-STATUS 'S0401'.
  SET TITLEBAR 'T0401'.
ENDMODULE.
*&---------------------------------------------------------------------*
*& Module STATUS_0400 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_0400 OUTPUT.
  SET PF-STATUS 'S0400'.
  SET TITLEBAR 'T0400'.
ENDMODULE.
*&---------------------------------------------------------------------*
*& Module SET_BEFOREEACH_400 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE set_beforeeach_400 OUTPUT.


  PERFORM get_pdname_400 USING    zsess23001-prdid
                         CHANGING zsess23001-prdnm.

  PERFORM get_username_400 USING    zsess23001-empid
                           CHANGING zsess23001-empna.


*    DATA : lv_username TYPE zsess23001-empna.
*    CLEAR : lv_username.
*
*    SELECT empna
*      INTO lv_username
*      FROM ztess0301
*      WHERE empid = zsess23001-empid.
*
*      zsess23001-empna = lv_username.



ENDMODULE.
*&---------------------------------------------------------------------*
*& Module BEFORE_EACH_0300 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE before_each_0300 OUTPUT.



ENDMODULE.
*&---------------------------------------------------------------------*
*& Module STATUS_0500 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_0500 OUTPUT.
  SET PF-STATUS 'S0500'.
  SET TITLEBAR 'T0500'.
ENDMODULE.
*&---------------------------------------------------------------------*
*& Module INIT_TREE OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE init_tree OUTPUT.

  IF g_tree IS INITIAL.
    DATA : node_table TYPE node_table_type.
    DATA : events TYPE cntl_simple_events,
           event  TYPE cntl_simple_event.


    CREATE OBJECT tree_con_ref
      EXPORTING
        container_name = 'TREE_CONTAINER'.                 " Name of the Screen CustCtrl Name to Link Container To

    CREATE OBJECT g_tree
      EXPORTING
        parent              = tree_con_ref                " Parent Container
        node_selection_mode = cl_gui_simple_tree=>node_sel_mode_single. " "

    PERFORM build_node_table USING node_table.

    CALL METHOD g_tree->add_nodes
      EXPORTING
        table_structure_name = 'MTREESNODE'                " Name of Structure of Node Table
        node_table           = node_table.               " Node table

    event-eventid = cl_gui_simple_tree=>eventid_node_double_click.
    event-appl_event = 'X'. " process PAI if event occurs
    APPEND event TO events.

    CALL METHOD g_tree->set_registered_events
      EXPORTING
        events                    = events
      EXCEPTIONS
        cntl_error                = 1
        cntl_system_error         = 2
        illegal_event_combination = 3.


  ENDIF.
ENDMODULE.
*&---------------------------------------------------------------------*
*& Module INIT_CON OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE init_con OUTPUT.

  IF con1_ref IS INITIAL.
    CREATE OBJECT con1_ref
      EXPORTING
        container_name = 'CON5'.

    CREATE OBJECT grid1
      EXPORTING
        i_parent = con1_ref.

    CREATE OBJECT g_application.
    SET HANDLER g_application->handle_node_double_click FOR g_tree.


    PERFORM setting_layout_tree.
    PERFORM setting_toolbar.
    PERFORM setting_sort.
    PERFORM setting_event.

    CALL METHOD grid1->set_table_for_first_display
      EXPORTING
        i_structure_name     = 'ZSESS24001'
        i_save               = 'A'
        is_variant           = gs_variant  " variant display
        i_default            = ' '
        is_layout            = gs_layout
        it_toolbar_excluding = gs_toolbar
      CHANGING
        it_outtab            = gt_order_tree
        it_fieldcatalog      = gt_fcat2            " Field Catalog
        it_sort              = gt_sort.

  ENDIF.
*  IF gcl_container IS NOT INITIAL.
*
*    CREATE OBJECT gcl_container
*      EXPORTING
*        container_name = 'CON1'.
*
*    CREATE OBJECT gcl_alv_grid
*      EXPORTING
*        i_parent = gcl_container.
*
*    CREATE OBJECT g_application.
*    SET HANDLER g_application->handle_node_double_click FOR g_tree.
*
*    PERFORM setting_layout_tree.
*    PERFORM setting_toolbar.
*    PERFORM setting_sort.
*    PERFORM setting_event.
*
*    CALL METHOD gcl_alv_grid->set_table_for_first_display
*      EXPORTING
**       i_buffer_active               =
**       i_bypassing_buffer            =
**       i_consistency_check           =
*        i_structure_name              = 'ZSESS24001'
*        is_variant                    = gs_variant
*        i_save                        = 'A'
*        i_default                     = 'X'
*        is_layout                     = gs_layout
**       is_print                      =
**       it_special_groups             =
*        it_toolbar_excluding          = gs_toolbar
**       it_hyperlink                  =
**       it_alv_graphics               =
**       it_except_qinfo               =
**       ir_salv_adapter               =
*      CHANGING
*        it_outtab                     = gt_order
*        it_fieldcatalog               = gt_fcat
*        it_sort                       = gt_sort
**       it_filter                     =
*      EXCEPTIONS
*        invalid_parameter_combination = 1
*        program_error                 = 2
*        too_many_lines                = 3
*        OTHERS                        = 4.
*    IF sy-subrc <> 0.
** Implement suitable error handling here
*    ENDIF.
*
*  ENDIF.




ENDMODULE.
*&---------------------------------------------------------------------*
*& Module BEFOREEACH_500 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE beforeeach_500 OUTPUT.

*
*  SELECT a~prhid a~pntid a~empid a~title a~prdat a~crtdm a~totlp a~currc a~odchk b~pntnm c~empna
*INTO CORRESPONDING FIELDS OF TABLE gt_order
*FROM ztess2401 AS a
*INNER JOIN ztess2501 AS b "구매오더 table 의 공장코드(pntid)를 통해 위탁공장의 이름(pntnm)을 가져온다.
*ON a~pntid = b~pntid
*INNER JOIN ztess0301 AS c "구매오더 table 의 사원코드(empid)를 통해 사원 이름(empid)을 가져온다.
*ON a~empid = c~empid.



ENDMODULE.


#SAPMZESS0703_I01
*&---------------------------------------------------------------------*
*& Include          SAPMZESS0703_I01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0100  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_0100 INPUT.
  CASE ok_code.
    WHEN 'BACK'.
      CLEAR ok_code.
      LEAVE TO SCREEN 0.

    WHEN 'SEARCH'.
      CLEAR ok_code.
      "Search 버튼 클릭시 조건에 맞는 데이터 alv에 전달
      PERFORM set_data USING gs_order
                             zsess24002-prhid_b
                             zsess24002-prhid_e
                             zsess24002-pntid
                       CHANGING gt_order.
      gi_return = 'X'. "SET_STATUS 설정.

      PERFORM set_icon_odchk.

      gv_list_cnt = lines( gt_order ).


    WHEN 'DETAIL'.
      CLEAR ok_code.

      "Search실행 후  ALV 클릭시 해당 행에 저장되어 있는 index 가져오기.
      PERFORM set_selected_rows.

      "ALV index에 해당하는 DATA를 SCREEN200 구매오더상세DATA로 미리 탑재.
      PERFORM set_detail_data USING    gs_row
                                       gt_rows
                                       gt_order
                                       gs_order
                              CHANGING zsess24001.
      CALL SCREEN 200.

    WHEN 'CREATE'.
      CLEAR ok_code.
      CALL SCREEN 301.

    WHEN 'EDIT'.
      CLEAR ok_code.
      "Search실행 후  ALV 클릭시 해당 행에 저장되어 있는 index 가져오기.
      PERFORM set_selected_rows.

      PERFORM set_edited_before_data USING    gs_row
                                              gt_rows
                                              gt_order
                                              gs_order
                                     CHANGING zsess24004.
      CALL  SCREEN 401.

    WHEN 'CHECK'. " todo 구매오더 상세 okchk 가 모두다 t이면 승인 가능하게 조건 로직 작성하기.
      CLEAR ok_code.
      PERFORM set_check_t.
      PERFORM set_data USING gs_order
                       zsess24002-prhid_b
                       zsess24002-prhid_e
                       zsess24002-pntid
                 CHANGING gt_order.

      PERFORM set_icon_odchk.
      PERFORM set_input_27.


    WHEN 'DENY'.
      CLEAR : ok_code.
      PERFORM set_check_f.
      PERFORM set_data USING gs_order
                 zsess24002-prhid_b
                 zsess24002-prhid_e
                 zsess24002-pntid
           CHANGING gt_order.
      PERFORM set_icon_odchk.
*      PERFORM get_search_data .

    WHEN 'TREE'.
      CALL SCREEN 500.


  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  EXIT  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE exit INPUT.

  CASE ok_code.
    WHEN 'EXIT'.
      LEAVE PROGRAM.
    WHEN 'CANC'.
      PERFORM clear_alv. "alv + container 제거.
      LEAVE PROGRAM.
  ENDCASE.


ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  VALIDATION_100  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE validation_100 INPUT.

* Screen 100번의 구매오더코드 왼쪽 조건과 오른쪽 조건에 대한 validation.
  PERFORM validation_prhid USING  zsess24002-prhid_b
                                  zsess24002-prhid_e.



ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  EXIT_0200  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE exit_0200 INPUT.
  CASE ok_code.
    WHEN 'EXIT'.
      LEAVE PROGRAM.
    WHEN 'CANC'.
      PERFORM set_data USING gs_order
                       zsess24002-prhid_b
                       zsess24002-prhid_e
                       zsess24002-pntid
                 CHANGING gt_order.
       PERFORM set_icon_odchk.
      LEAVE TO SCREEN 100.
  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0200  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_0200 INPUT.

  CASE ok_code.
    WHEN 'DETAIL'.
      CLEAR ok_code.

    WHEN 'CREATE'.
      CLEAR ok_code.

      CLEAR :zsess23001.

*     구매오더상세 화면 구매오더코드 세팅
      PERFORM set_orderdetail_prhid USING    zsess24001-prhid
                                    CHANGING zsess23001-prhid.

*     구매오더상세 화면 문서발행일자 세팅
      PERFORM set_prbdt_datum  USING    zsess23001-prbdt
                               CHANGING zsess23001-prbdt.

      CALL SCREEN 300.

    WHEN 'BACK'.
      CLEAR : ok_code.
*     업데이트된 gt_order data를 넣는다.
      PERFORM set_data USING gs_order
                             zsess24002-prhid_b
                             zsess24002-prhid_e
                             zsess24002-pntid
                       CHANGING gt_order.
      LEAVE TO SCREEN 0.
    WHEN 'EDIT'.
      PERFORM set_selected_rows_200.

      "ALV index에 해당하는 DATA를 SCREEN200 구매오더상세DATA로 미리 탑재.
      PERFORM set_orderdetail_data USING    gs_row
                                            gt_rows
                                            gt_orderdetail
                                            gs_orderdetail
                                   CHANGING zsess23002.

      CALL SCREEN 400.


  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0300  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_0300 INPUT.

  CASE ok_code.
    WHEN 'BACK'.
      CLEAR ok_code.
      LEAVE TO SCREEN 0.
    WHEN 'SAVE'.
*     데이터 저장시 주문상세table(ztess2301) insert + alv 내용 추가.
      PERFORM set_detail_ndata USING    zsess23001
                                        gs_orderdetail
                               CHANGING gt_orderdetail.


  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  EXIT_0300  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE exit_0300 INPUT.

  CASE ok_code.
    WHEN 'EXIT'.
      LEAVE PROGRAM.
    WHEN 'CANC'.
      PERFORM clear_alv_200. "alv + container 제거.
       PERFORM set_icon_odchk.
      LEAVE TO SCREEN 0.
  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  EXIT_0301  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE exit_0301 INPUT.

  CASE ok_code.
    WHEN 'EXIT'.
      LEAVE PROGRAM.
    WHEN 'CANC'.
      PERFORM clear_alv.
      LEAVE TO SCREEN 0.
  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0301  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_0301 INPUT.

  CASE ok_code.
    WHEN 'SAVE'.
      CLEAR ok_code.
      " 저장하는 시점에 구매오더상세코드 생성이 되어야 한다.
      " TODO Screen 에서 구매오더 상세코드지우기
*     구매오더 자동 채번 기능
      PERFORM before_each_prhid.

*        PERFORM set_prhid_data_0301 USING      zsess24003-prhid
*                                               gs_orderdetail
*                                    CHANGING   gt_orderdetail.


*      zsess24003-prhid
      CLEAR : zsess24001.

      zsess24001-prhid = zsess24003-prhid.
      zsess24001-pntid = zsess24003-pntid. " 공장코드
      zsess24001-pntnm = zsess24003-pntnm. " 공장명
      zsess24001-empid = zsess24003-empid. " 사원코드
      zsess24001-empna = zsess24003-empna. " 사원 이름
      zsess24001-title = zsess24003-title. " 제목
      zsess24001-prdat = zsess24003-prdat. " 발주일자
      zsess24001-crtdm = zsess24003-crtdm. " 문서생성일시
      zsess24001-totlp = zsess24003-totlp. " 총구매금액
      zsess24001-currc = zsess24003-currc. " 통화
      zsess24001-odchk = zsess24003-odchk. " 담당자 승인 여부
      CALL SCREEN 200.



    WHEN 'BACK'.
      CLEAR ok_code.
      LEAVE TO SCREEN 0.
    WHEN OTHERS.
  ENDCASE.


ENDMODULE.


*&SPWIZARD: INPUT MODULE FOR TS 'MYTAB'. DO NOT CHANGE THIS LINE!
*&SPWIZARD: GETS ACTIVE TAB
MODULE mytab_active_tab_get INPUT.
  ok_code = sy-ucomm.
  CASE ok_code.
    WHEN c_mytab-tab1.
      g_mytab-pressed_tab = c_mytab-tab1.
      CLEAR : gt_order. " 다른 조건으로 넘어가면 조회 목록을 삭제하자.
    WHEN c_mytab-tab2.
      g_mytab-pressed_tab = c_mytab-tab2.
      CLEAR : gt_order. " 다른 조건으로 넘어가면 조회 목록을 삭제하자.
    WHEN c_mytab-tab3.
      g_mytab-pressed_tab = c_mytab-tab3.
      CLEAR : gt_order. " 다른 조건으로 넘어가면 조회 목록을 삭제하자.
    WHEN OTHERS.
*&SPWIZARD:      DO NOTHING
  ENDCASE.
ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  EXIT_0400  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE exit_0400 INPUT.

  CASE ok_code.
    WHEN 'EXIT'.
      LEAVE PROGRAM.
    WHEN 'CANC'.
      PERFORM clear_alv_200.
      PERFORM set_data USING gs_order
                 zsess24002-prhid_b
                 zsess24002-prhid_e
                 zsess24002-pntid
           CHANGING gt_order.
      LEAVE TO SCREEN 0.
  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0401  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_0401 INPUT.

  CASE ok_code.
    WHEN 'BACK'.
      PERFORM set_data USING gs_order
                       zsess24002-prhid_b
                       zsess24002-prhid_e
                       zsess24002-pntid
                 CHANGING gt_order.

       PERFORM set_icon_odchk.
      LEAVE TO SCREEN 0.

    WHEN 'SAVE'.

      PERFORM set_save_data_0401 USING    zsess24004
                                 CHANGING gt_order.



  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0400  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_0400 INPUT.

  CASE ok_code.
    WHEN 'BACK'.
      CLEAR : ok_code.
      LEAVE TO SCREEN 0.

    WHEN 'SAVE'.
      PERFORM set_detail_ndata_400 USING    zsess23001
                                            gs_orderdetail
                                   CHANGING gt_orderdetail
                                            zsess24001.

  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  F4_PRDID  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE f4_prdid INPUT.

  PERFORM f4_prdid.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  F4_EMPID  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE f4_empid INPUT.

  PERFORM f4_empid.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  CHECK  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE check INPUT.


ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  EXIT_0500  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE exit_0500 INPUT.

  CASE ok_code.
    WHEN 'EXIT'.
      CLEAR : ok_code.
      LEAVE PROGRAM.
    WHEN 'CANC'.
      CLEAR : ok_code.
      LEAVE TO SCREEN 0.
    WHEN OTHERS.
  ENDCASE.

ENDMODULE.

# PERFORM

*&---------------------------------------------------------------------*
*& Include          SAPMZESS0703_F01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Form clear_alv
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM clear_alv .

  IF gcl_alv_grid IS NOT INITIAL.
    CALL METHOD gcl_alv_grid->free.
    CALL METHOD gcl_container->free.
    CLEAR : gcl_alv_grid, gcl_container.

  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_fcat_layout
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_fcat_layout .

  CLEAR : gs_layo.
  PERFORM setting_layout CHANGING gs_layo.

  IF gt_fcat IS INITIAL.

    PERFORM set_fcat100_1 USING :    gs_fcat-fieldname
                                     gs_fcat-coltext
                                     gs_fcat-ref_table
                                     gs_fcat-ref_field
                                     gs_fcat-edit
                                     gs_fcat-no_out
                                     gs_fcat-icon
                          CHANGING : gs_fcat
                                     gt_fcat.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form init_sel_cond
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24001
*&      <-- ZSESS24002_PRHID_B
*&      <-- ZSESS24002_PRHID_E
*&---------------------------------------------------------------------*
FORM init_sel_cond  USING    VALUE(p_prhid) TYPE zsess24001-prhid
                    CHANGING       p_prhid_b
                                   p_prhid_e.
* todo load of program 으로 보내기.
  SELECT SINGLE MIN( prhid )
    FROM ztess2401
    INTO p_prhid.

  p_prhid_b = p_prhid. "Screen 100번 왼쪽 조건 대입"
  CLEAR : p_prhid.

  SELECT SINGLE MAX( prhid )
    FROM ztess2401
    INTO p_prhid.

  p_prhid_e = p_prhid. "Screen 100번 오른쪽 조건 대입"
  CLEAR : p_prhid.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_alv_grid_100
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_alv_grid_100 .

  IF gcl_alv_grid IS NOT BOUND.
    CREATE OBJECT gcl_alv_grid
      EXPORTING
*       i_shellstyle      = 0                " Control Style
*       i_lifetime        =                  " Lifetime
        i_parent          = gcl_container                 " Parent Container
*       i_appl_events     = space            " Register Events as Application Events
*       i_parentdbg       =                  " Internal, Do not Use
*       i_applogparent    =                  " Container for Application Log
*       i_graphicsparent  =                  " Container for Graphics
*       i_name            =                  " Name
*       i_fcat_complete   = space            " Boolean Variable (X=True, Space=False)
*       o_previous_sral_handler =
      EXCEPTIONS
        error_cntl_create = 1                " Error when creating the control
        error_cntl_init   = 2                " Error While Initializing Control
        error_cntl_link   = 3                " Error While Linking Control
        error_dp_create   = 4                " Error While Creating DataProvider Control
        OTHERS            = 5.
    IF sy-subrc <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    "EVENT PAGE 생성. TODO Error"
    CREATE OBJECT gcl_handler.
    SET HANDLER : gcl_handler->handle_double_click FOR gcl_alv_grid.


  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_first_display_100
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_first_display_100 .

  CALL METHOD gcl_alv_grid->set_table_for_first_display
    EXPORTING
*     i_buffer_active               =
*     i_bypassing_buffer            =
*     i_consistency_check           =
      i_structure_name              = 'ZSESS24001'
*     is_variant                    =
*     i_save                        =
*     i_default                     = 'X'
      is_layout                     = gs_layo
*     is_print                      =
*     it_special_groups             =
*     it_toolbar_excluding          =
*     it_hyperlink                  =
*     it_alv_graphics               =
*     it_except_qinfo               =
*     ir_salv_adapter               =
    CHANGING
      it_outtab                     = gt_order
      it_fieldcatalog               = gt_fcat
*     it_sort                       =
*     it_filter                     =
    EXCEPTIONS
      invalid_parameter_combination = 1
      program_error                 = 2
      too_many_lines                = 3
      OTHERS                        = 4.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form validation_prhid
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS2401_PRHID_B
*&      --> ZSESS2401_PRHID_E
*&---------------------------------------------------------------------*
FORM validation_prhid  USING    VALUE(p_prhid_b) TYPE zsess24002-prhid_b
                                VALUE(p_prhid_e) TYPE zsess24002-prhid_e.

  IF p_prhid_b IS INITIAL.
    MESSAGE e000 WITH '구매오더코드의 시작 값을 입력해주세요.'.


  ELSEIF p_prhid_e IS INITIAL.
    MESSAGE e000 WITH '구매오더코드의 마지막 값을 입력해주세요.'.


  ELSEIF p_prhid_b GT p_prhid_e.
    MESSAGE e000 WITH '구매오더코드의 마지막 값이 시작 값보다 작습니다. 다시 입력해주세요.'.


  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GS_ORDER
*&      --> GT_ORDER
*&      --> ZSESS24002_PRHID_B
*&      --> ZSESS24002_PRHID_E
*&      <-- ZTESS2401
*&---------------------------------------------------------------------*
FORM set_data  USING    VALUE(ps_order)   TYPE zsess24001
                        VALUE(pv_prhid_b) TYPE zsess24002-prhid_b
                        VALUE(pv_prhid_e) TYPE zsess24002-prhid_e
                        VALUE(pv_pntid)   TYPE zsess24002-pntid
               CHANGING       pt_order    TYPE ztess24001_h. "ztess24001_h => zsess24001을 사용한  table type

  DATA : lt_order TYPE TABLE OF ztess2401,
         ls_order LIKE LINE OF lt_order.

  CLEAR : ps_order, lt_order, ls_order.
  REFRESH : pt_order.


  CASE g_mytab-pressed_tab.
    WHEN c_mytab-tab1.
* 조건에 맞는 구매오더코드 data가져오기.
      PERFORM validation.

      PERFORM get_prhid_lt_order USING pv_prhid_b
                                       pv_prhid_e
                                 CHANGING lt_order.

* 조건에 맞는 구매오더코드의 추가 정보들을 JOIN 하는 로직.
* 구매오더 table(ZTESS2401) 위탁공장 table(ZTESS2501) 사원 table(ZTESS0301)'
      PERFORM set_ltorder_plus  USING ls_order
                                      lt_order
                                      ps_order
                                CHANGING pt_order.


    WHEN c_mytab-tab2.


* 조건에 맞는 구매오더코드 data가져오기. # 공장코드
      PERFORM get_prhid_lt_order_2  USING pv_pntid
                                 CHANGING lt_order.

* 구매오더 table(ZTESS2401) 위탁공장 table(ZTESS2501) 사원 table(ZTESS0301)'
      PERFORM set_ltorder_plus  USING ls_order
                                      lt_order
                                      ps_order
                                CHANGING pt_order.



  ENDCASE.




ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_fcat100
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24001_PRHID
*&      --> ZSESS24001_PNTID
*&      --> ZSESS24001_PNTNM
*&      --> ZSESS24001_EMPID
*&      --> ZSESS24001_EMPNA
*&      --> ZSESS24001_TITLE
*&      --> ZSESS24001_PRDAT
*&      --> ZSESS24001_CRTDM
*&      --> ZSESS24001_TOTLP
*&      --> ZSESS24001_CURRC
*&      --> ZSESS24001_ODCHK
*&      <-- GT_FCAT
*&---------------------------------------------------------------------*
*FORM set_fcat100  USING  VALUE(p_prhid) TYPE zsess24001-prhid
*                         VALUE(p_pntid) TYPE zsess24001-pntid
*                         VALUE(p_pntnm) TYPE zsess24001-pntnm
*                         VALUE(p_empid) TYPE zsess24001-empid
*                         VALUE(p_empna) TYPE zsess24001-empna
*                         VALUE(p_title) TYPE zsess24001-title
*                         VALUE(p_prdat) TYPE zsess24001-prdat
*                         VALUE(p_crtdm) TYPE zsess24001-crtdm
*                         VALUE(p_totlp) TYPE zsess24001-totlp
*                         VALUE(p_currc) TYPE zsess24001-currc
*                         VALUE(p_odchk) TYPE zsess24001-odchk
*                  CHANGING      ps_fcat TYPE lvc_s_fcat.
*                                pt_fcat TYPE lvc_t_fcat.
*
*
*  gs_fcat-fieldname = pv_field.
*  gs_fcat-coltext   = pv_text.
*  gs_fcat-ref_table = pv_ref_table.
*  gs_fcat-ref_field = pv_ref_field.
*  gs_fcat-edit      = pv_edit.
*  gs_fcat-no_out    = pv_no_out.  "ALV LIST에서 보이지 않을 필드

*ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_fcat100_1
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GS_FCAT_FIELDNAME
*&      --> GS_FCAT_COLTEXT
*&      --> GS_FCAT_REF_TABLE
*&      --> GS_FCAT_REF_FIELD
*&      --> GS_FCAT_EDIT
*&      --> GS_FCAT_NO_OUT
*&      <-- GT_FCAT
*&---------------------------------------------------------------------*
FORM set_fcat100_1  USING     VALUE(pv_fieldname)  TYPE lvc_s_fcat-fieldname
                              VALUE(pv_coltext)    TYPE lvc_s_fcat-coltext
                              VALUE(pv_ref_table)  TYPE lvc_s_fcat-ref_table
                              VALUE(pv_ref_field)  TYPE lvc_s_fcat-ref_field
                              VALUE(pv_edit)       TYPE lvc_s_fcat-edit
                              VALUE(pv_no_out)     TYPE lvc_s_fcat-no_out
                              VALUE(pv_icon)       TYPE lvc_s_fcat-icon
                    CHANGING         ps_fcat      TYPE lvc_s_fcat
                                     pt_fcat       TYPE lvc_t_fcat.

*PERFORM set_psTo_pt.

* 구매오더코드
  pv_fieldname = 'PRHID'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'PRHID'.
  pv_edit      = ' '.
  pv_no_out    = ' '.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-ref_table = pv_ref_table.
  ps_fcat-ref_field = pv_ref_field.
  ps_fcat-edit = pv_edit.
  ps_fcat-no_out = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR : ps_fcat.

* 공장코드
  pv_fieldname = 'PNTID'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'PNTID'.
  pv_edit      = ' '.
  pv_no_out    = 'X'.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-ref_table = pv_ref_table.
  ps_fcat-ref_field = pv_ref_field.
  ps_fcat-edit = pv_edit.
  ps_fcat-no_out = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR : ps_fcat.

* 공장명
  pv_fieldname = 'PNTNM'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2501'.
  pv_ref_field = 'PNTNM'.
  pv_edit      = ' '.
  pv_no_out    = ' '.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-ref_table = pv_ref_table.
  ps_fcat-ref_field = pv_ref_field.
  ps_fcat-edit = pv_edit.
  ps_fcat-no_out = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR : ps_fcat.

* 사원코드
  pv_fieldname = 'EMPID'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'EMPID'.
  pv_edit      = ' '.
  pv_no_out    = 'X'.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-ref_table = pv_ref_table.
  ps_fcat-ref_field = pv_ref_field.
  ps_fcat-edit = pv_edit.
  ps_fcat-no_out = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR : ps_fcat.

* 사원명
  pv_fieldname = 'EMPNA'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS0301'.
  pv_ref_field = 'EMPNA'.
  pv_edit      = ' '.
  pv_no_out    = ' '.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-ref_table = pv_ref_table.
  ps_fcat-ref_field = pv_ref_field.
  ps_fcat-edit = pv_edit.
  ps_fcat-no_out = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR : ps_fcat.

* 제목
  pv_fieldname = 'TITLE'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'TITLE'.
  pv_edit      = ' '.
  pv_no_out    = ' '.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-ref_table = pv_ref_table.
  ps_fcat-ref_field = pv_ref_field.
  ps_fcat-edit = pv_edit.
  ps_fcat-no_out = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR : ps_fcat.

* 발주일자
  pv_fieldname = 'PRDAT'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'PRDAT'.
  pv_edit      = ' '.
  pv_no_out    = ' '.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-ref_table = pv_ref_table.
  ps_fcat-ref_field = pv_ref_field.
  ps_fcat-edit = pv_edit.
  ps_fcat-no_out = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR : ps_fcat.

* 문서생성일시
  pv_fieldname = 'CRTDM'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'CRTDM'.
  pv_edit      = ' '.
  pv_no_out    = ' '.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-ref_table = pv_ref_table.
  ps_fcat-ref_field = pv_ref_field.
  ps_fcat-edit = pv_edit.
  ps_fcat-no_out = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR : ps_fcat.

* 총구매금액
  pv_fieldname = 'TOTLP'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'TOTLP'.
  pv_edit      = ' '.
  pv_no_out    = ' '.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-ref_table = pv_ref_table.
  ps_fcat-ref_field = pv_ref_field.
  ps_fcat-edit = pv_edit.
  ps_fcat-no_out = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR : ps_fcat.

* 통화
  pv_fieldname = 'CURRC'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'CURRC'.
  pv_edit      = ' '.
  pv_no_out    = ' '.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-ref_table = pv_ref_table.
  ps_fcat-ref_field = pv_ref_field.
  ps_fcat-edit = pv_edit.
  ps_fcat-no_out = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR : ps_fcat.

* 담당자 승인 여부
  pv_fieldname = 'ODCHK'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'ODCHK'.
  pv_edit      = ' '.
  pv_no_out    = 'X'.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-ref_table = pv_ref_table.
  ps_fcat-ref_field = pv_ref_field.
  ps_fcat-edit = pv_edit.
  ps_fcat-no_out = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR : ps_fcat.

*아이콘
  pv_fieldname = 'ICOND'.
  pv_coltext   = '담당자승인여부'.
  pv_icon      = 'X'.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-coltext = pv_coltext.
  ps_fcat-icon   =  pv_icon.
  APPEND ps_fcat TO pt_fcat.
  CLEAR ps_fcat.

  pv_fieldname = 'DFLAG'.
  pv_no_out = 'X'.

  ps_fcat-fieldname = pv_fieldname.
  ps_fcat-no_out    = pv_no_out.
  APPEND ps_fcat TO pt_fcat.
  CLEAR ps_fcat.



ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_psTo_pt
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_psto_pt .

*  ps_fcat-fieldname = pv_fieldname .
*  ps_fcat-coltext   = pv_coltext   .
*  ps_fcat-ref_table = pv_ref_table .
*  ps_fcat-ref_field = pv_ref_field .
*  ps_fcat-edit      = pv_edit      .
*  ps_fcat-no_out    = pv_no_out    .
*  APPEND ps_fcat TO pt_fcat.
*  CLEAR : ps_fcat.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_selected_rows
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_selected_rows .

  CLEAR : gt_rows, gs_row.

  CALL METHOD gcl_alv_grid->get_selected_rows
    IMPORTING
      et_index_rows = gt_rows.


  IF gt_rows IS INITIAL.
    MESSAGE e000 WITH '행을 선택해주세요.'.
    RETURN.
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_detail_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GS_ROW
*&      --> GT_ROWS
*&      --> GT_ORDER
*&      --> GS_ORDER
*&      <-- ZSESS24001
*&---------------------------------------------------------------------*
FORM set_detail_data  USING    VALUE(ps_row)      TYPE lvc_s_row
                               VALUE(pt_rows)     TYPE lvc_t_row
                               VALUE(pt_order)    TYPE ztess24001_h
                               VALUE(ps_order)    TYPE zsess24001
                      CHANGING       p_zsess24001 TYPE zsess24001.


  CLEAR : p_zsess24001.

  IF sy-subrc EQ 0.
    LOOP AT pt_rows INTO ps_row.

      READ TABLE pt_order INTO ps_order INDEX ps_row-index. "Screen 100의 검색버튼 작동 이후, ALV에서 선택한 값을 Screen 200에 미리 대입.

      p_zsess24001-prhid = ps_order-prhid. " 구매오더코드
      p_zsess24001-pntid = ps_order-pntid. " 공장코드
      p_zsess24001-pntnm = ps_order-pntnm. " 공장명
      p_zsess24001-empid = ps_order-empid. " 사원코드
      p_zsess24001-empna = ps_order-empna. " 사원 이름
      p_zsess24001-title = ps_order-title. " 제목
      p_zsess24001-prdat = ps_order-prdat. " 발주일자
      p_zsess24001-crtdm = ps_order-crtdm. " 문서생성일시
      p_zsess24001-totlp = ps_order-totlp. " 총구매금액
      p_zsess24001-currc = ps_order-currc. " 통화
      p_zsess24001-odchk = ps_order-odchk. " 담당자 승인 여부

    ENDLOOP.

  ENDIF.



ENDFORM.
*&---------------------------------------------------------------------*
*& Form clear_alv_200
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM clear_alv_200 .

  IF gcl_alv_grid200 IS NOT INITIAL.
    CALL METHOD gcl_alv_grid200->free.
    CALL METHOD gcl_container200->free.
    CLEAR : gcl_alv_grid200, gcl_container200.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_fcat_layout_200
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_fcat_layout_200 .

  CLEAR : gs_layo. "이전 Screen에서 사용한 gs_layout 제거.
  gs_layo-zebra = 'X'.
  gs_layo-cwidth_opt = 'X'.

  IF gt_fcat200 IS INITIAL.

    PERFORM set_fcat200_1 USING :    gs_fcat200-fieldname
                                     gs_fcat200-coltext
                                     gs_fcat200-ref_table
                                     gs_fcat200-ref_field
                                     gs_fcat200-edit
                                     gs_fcat200-no_out
                                     gs_fcat200-icon
                                     gs_fcat200-col_pos
                                     gs_fcat200-currency
                          CHANGING : gt_fcat200.



  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_fcat200_1
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GS_FCAT_FIELDNAME200
*&      --> GS_FCAT_COLTEXT200
*&      --> GS_FCAT_REF_TABLE200
*&      --> GS_FCAT_REF_FIELD200
*&      --> GS_FCAT_EDIT200
*&      --> GS_FCAT_NO_OUT200
*&      --> GS_FCAT_ICON200
*&      <-- GT_FCAT200
*&---------------------------------------------------------------------*
FORM set_fcat200_1  USING     pv_fieldname  TYPE lvc_s_fcat-fieldname
                              pv_coltext    TYPE lvc_s_fcat-coltext
                              pv_ref_table  TYPE lvc_s_fcat-ref_table
                              pv_ref_field  TYPE lvc_s_fcat-ref_field
                              pv_edit       TYPE lvc_s_fcat-edit
                              pv_no_out     TYPE lvc_s_fcat-no_out
                              pv_icon       TYPE lvc_s_fcat-icon
                              pv_col_pos    TYPE lvc_s_fcat-col_pos
                              pv_currency   TYPE lvc_s_fcat-currency
                    CHANGING  pt_fcat       TYPE lvc_t_fcat.


* 구매오더상세코드
  pv_fieldname = 'PODID'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'PODID'.
  pv_edit      = ' '.
  pv_no_out    = ' '.
  pv_col_pos   = '1'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.

* 구매오더코드
  pv_fieldname = 'PRHID'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'PRHID'.
  pv_edit      = ' '.
  pv_no_out    = 'X'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.

* 사원코드
  pv_fieldname = 'EMPID'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'EMPID'.
  pv_edit      = ' '.
  pv_no_out    = 'X'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.

* 사원명
  pv_fieldname = 'EMPNA'.
  pv_coltext   = '담당 사원명'.
  pv_ref_table = 'ZTESS0301'.
  pv_ref_field = 'EMPNA'.
  pv_edit      = ' '.
  pv_no_out    = ' '.
  pv_col_pos   = '2'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.

* 제품코드
  pv_fieldname = 'PRDID'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2501'.
  pv_ref_field = 'PRDID'.
  pv_edit      = ' '.
  pv_no_out    = 'X'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.

* 제품명
  pv_fieldname = 'PRDNM'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2501'.
  pv_ref_field = 'PRDNM'.
  pv_edit      = ' '.
  pv_no_out    = ' '.
  pv_col_pos   = '3'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.


* 제품수량
  pv_fieldname = 'PDCNT'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2301'.
  pv_ref_field = 'PDCNT'.
  pv_edit      = ' '.
  pv_no_out    = ' '.
  pv_col_pos   = '4'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.

* 제품 원가
  pv_fieldname = 'PRDCO'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS1501'.
  pv_ref_field = 'PRDCO'.
  pv_edit      = ' '.
  pv_no_out    = ' '.
  pv_col_pos   = '5'.
  pv_currency  = 'KRW'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.

* 제품 원가별 총합

  pv_fieldname = 'SUMAL'.
  pv_coltext   = '원가 총합'.
  pv_edit      = ' '.
  pv_no_out    = ' '.
  pv_col_pos   = '6'.
  pv_currency  = 'KRW'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.

* 수량단위
  pv_fieldname = 'PUNIT'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2301'.
  pv_ref_field = 'PUNIT'.
  pv_edit      = ' '.
  pv_no_out    = ' '.
  pv_col_pos   = '7'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.

* 구매요청일자
  pv_fieldname = 'PRBDT'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2301'.
  pv_ref_field = 'PRBDT'.
  pv_edit      = ' '.
  pv_no_out    = ' '.
  pv_col_pos   = '8'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.

* 담당자 승인 여부
  pv_fieldname = 'ODCHK'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2401'.
  pv_ref_field = 'ODCHK'.
  pv_edit      = ' '.
  pv_no_out    = 'X'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR : gs_fcat.

*아이콘
  pv_fieldname = 'ICOND'.
  pv_coltext   = '담당자승인여부'.
  gs_fcat-icon      = 'X'.
  APPEND gs_fcat200 TO pt_fcat.
  CLEAR gs_fcat.










ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_container_200
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_container_200 .

*container 생성
  IF gcl_container200 IS NOT BOUND.
    CREATE OBJECT gcl_container200
      EXPORTING
*       parent                      =                  " Parent container
        container_name              = 'CON2'                 " Name of the Screen CustCtrl Name to Link Container To
*       style                       =                  " Windows Style Attributes Applied to this Container
*       lifetime                    = lifetime_default " Lifetime
*       repid                       =                  " Screen to Which this Container is Linked
*       dynnr                       =                  " Report To Which this Container is Linked
*       no_autodef_progid_dynnr     =                  " Don't Autodefined Progid and Dynnr?
      EXCEPTIONS
        cntl_error                  = 1                " CNTL_ERROR
        cntl_system_error           = 2                " CNTL_SYSTEM_ERROR
        create_error                = 3                " CREATE_ERROR
        lifetime_error              = 4                " LIFETIME_ERROR
        lifetime_dynpro_dynpro_link = 5                " LIFETIME_DYNPRO_DYNPRO_LINK
        OTHERS                      = 6.
    IF sy-subrc <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_alv_grid_200
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_alv_grid_200 .

  IF gcl_alv_grid200 IS NOT BOUND.
    CREATE OBJECT gcl_alv_grid200
      EXPORTING
*       i_shellstyle      = 0                " Control Style
*       i_lifetime        =                  " Lifetime
        i_parent          = gcl_container200                 " Parent Container
*       i_appl_events     = space            " Register Events as Application Events
*       i_parentdbg       =                  " Internal, Do not Use
*       i_applogparent    =                  " Container for Application Log
*       i_graphicsparent  =                  " Container for Graphics
*       i_name            =                  " Name
*       i_fcat_complete   = space            " Boolean Variable (X=True, Space=False)
*       o_previous_sral_handler =
      EXCEPTIONS
        error_cntl_create = 1                " Error when creating the control
        error_cntl_init   = 2                " Error While Initializing Control
        error_cntl_link   = 3                " Error While Linking Control
        error_dp_create   = 4                " Error While Creating DataProvider Control
        OTHERS            = 5.
    IF sy-subrc <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_first_display_200
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_first_display_200 .

  CALL METHOD gcl_alv_grid200->set_table_for_first_display
    EXPORTING
*     i_buffer_active               =
*     i_bypassing_buffer            =
*     i_consistency_check           =
      i_structure_name              = 'ZSESS23001'
*     is_variant                    =
*     i_save                        =
*     i_default                     = 'X'
      is_layout                     = gs_layo
*     is_print                      =
*     it_special_groups             =
*     it_toolbar_excluding          =
*     it_hyperlink                  =
*     it_alv_graphics               =
*     it_except_qinfo               =
*     ir_salv_adapter               =
    CHANGING
      it_outtab                     = gt_orderdetail
      it_fieldcatalog               = gt_fcat200
*     it_sort                       =
*     it_filter                     =
    EXCEPTIONS
      invalid_parameter_combination = 1
      program_error                 = 2
      too_many_lines                = 3
      OTHERS                        = 4.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_prhid_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24001_PRHID
*&      <-- GT_ORDERDETAIL
*&---------------------------------------------------------------------*
FORM set_prhid_data  USING    VALUE(pv_prhid)       TYPE zsess24001-prhid
                              VALUE(ps_orderdetail) TYPE zsess23001
                     CHANGING pt_orderdetail        TYPE ztess23001_h.


  SELECT a~podid "구매오더상세코드
         a~prhid
         a~prdid
         a~pdcnt
         a~punit
         a~prbdt
         a~odchk
         a~empid
         b~prdnm  "제품이름
         c~empna  "사원이름
         d~prdco  "제품 원가
   INTO CORRESPONDING FIELDS OF TABLE pt_orderdetail
   FROM ztess2301 AS a       " 구매오더 상세 TABLE
   INNER JOIN ztess1601 AS b " 제품 TABLE
   ON a~prdid = b~prdid      " 제품코드 비교 join 해서 '제품 이름'을 얻는 목적
   INNER JOIN ztess0301 AS c " 사원 TABLE
   ON a~empid = c~empid      " 사원코드 비교 join 해서 '사원 이름'을 얻는 목적
   INNER JOIN ztess1501 AS d " 제품 원가 이력 TABLE
   ON a~prdid = d~prdid     "제품코드가 같고 만료일자가 9999-12-31인 조건을 비교해서 '제품 원가를 얻는 목적'
   AND d~valide = '99991231'
   WHERE prhid = pv_prhid "스크린의 오더코드와,  똑같은 오더코드를 가지고 있는 데이터를 DB에서가져와 주세요.
   ORDER BY podid. " 구매오더상세코드를 기준으로 오름차순 해주세요.

  " 해당 오더코드에 속한 오더상세코드들 각각에 대한 원가 총합을 구하는 로직 + internal table 업데이트,  NOT DB반영.
  PERFORM set_sumal_data USING    ps_orderdetail
                         CHANGING pt_orderdetail.






*수정 이전 code-----------------------------------------------------------------------------------------------------------------------
*perform 예정
*alv에서 가져온 총 행들의 총 합을 구한 후, 스트럭쳐를 변경하고, db에 직접 반영하여, 구매오더의  총금액을 바꾸는 작업.
*  PERFORM set_totlp_db   USING ps_orderdetail
*                               pt_orderdetail
*                         CHANGING  zsess24001-totlp.



**과거 CODE. -수정 전-
** perform 예정
**제품 원가 가장 최신꺼 pt_orderdetail에 반영하기
*
*  DATA : lv_prdid TYPE zsess23001-prdid.
*  DATA : lt_data TYPE TABLE OF ztess1501,
*         ls_data LIKE LINE OF lt_data.
*  DATA : ls_tmp LIKE LINE OF lt_data.
*
*  CLEAR   : lv_prdid, ls_data, ls_tmp.
*  REFRESH : lt_data.
*
**Loop를 돌면서 각 줄의 제품코드들의 가격 정보를 가져온다.
*  LOOP AT pt_orderdetail INTO ps_orderdetail.
*    lv_prdid = ps_orderdetail-prdid.
*    CLEAR: lt_data.
*
*    SELECT *
*    INTO CORRESPONDING FIELDS OF TABLE lt_data
*    FROM ztess1501
*    WHERE prdid = lv_prdid
*    ORDER BY validb DESCENDING.
*
*
**  valide 를 변수를 활용해서 사용하기. =>TODO 코드 최적화
*
*    READ TABLE lt_data INTO ls_data INDEX 1.
*    ls_tmp = ls_data.
*    CLEAR : ls_data.
*
*    ps_orderdetail-prdco = ls_tmp-prdco. "제품 원가
*    ps_orderdetail-sumal = ls_tmp-prdco * ps_orderdetail-pdcnt. " 제품 총가격.
*    CLEAR : ls_tmp.
*
*    MODIFY pt_orderdetail FROM ps_orderdetail.
*    CLEAR : ps_orderdetail.
*
*  ENDLOOP.
*
**perform 예정
**alv에서 가져온 총 행들의 총 합을 구한 후, db에 직접 반영하여, 구매오더의  총금액을 바꾸는 작업.
*  DATA : lv_cnt TYPE c LENGTH 30.
*  DATA : lv_prhid2 TYPE zsess23001-prhid.
*  CLEAR : lv_cnt, lv_prhid2, gs_orderdetail.
*
*  LOOP AT gt_orderdetail INTO gs_orderdetail.
*    lv_cnt += gs_orderdetail-sumal.
*  ENDLOOP.
*
*  IF gs_orderdetail-prhid EQ zsess24001-prhid.
*    lv_prhid2 = zsess24001-prhid.
*    zsess24001-totlp = lv_cnt.
*
*    UPDATE ztess2401 SET totlp = lv_cnt WHERE prhid = lv_prhid2.
*
*
** TODO COmmit or rollback.
**    IF sy-subrc EQ 0.
**
**    ENDIF.
*
*  ENDIF.
*
*  IF sy-subrc EQ 0.
*
*  ENDIF.




ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_orderdetail_prhid
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24001_PRHID
*&      <-- ZSESS23001_PRHID
*&---------------------------------------------------------------------*
FORM set_orderdetail_prhid  USING    VALUE(pv_prhid_h) TYPE zsess24001-prhid
                            CHANGING       pv_prhid_d  TYPE zsess23001-prhid.

  pv_prhid_d = pv_prhid_h.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_detail_ndata
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS23001
*&      --> GS_ORDERDETAIL
*&      <-- GT_ORDERDETAIL
*&---------------------------------------------------------------------*
FORM set_detail_ndata  USING    VALUE(ps_zsess23001) TYPE zsess23001
                                VALUE(ps_orderdetail) TYPE zsess23001 "상세코드
                       CHANGING pt_orderdetail TYPE ztess23001_h.


  DATA : ls_save  TYPE ztess2301,
         lt_save  TYPE TABLE OF ztess2301,
         lv_name  TYPE zsess24001-empna, " 사원 이름
         lv_prdnm TYPE zsess23001-prdnm, " 제품 이름
         lv_prdco TYPE zsess23001-prdco.  " 제품 원가

  CLEAR : ls_save, lv_name, lv_prdnm, lv_prdco.
  REFRESH : lt_save.


* Screen 구매상세코드를 자동으로 채번해 주는 프로그램.
  PERFORM before_each_pohid USING    ps_zsess23001
                            CHANGING ps_zsess23001-podid
                                     ps_zsess23001-prbdt.


* Screen layout 에서 입력된 변수를 structure에 저장.
  PERFORM set_layout_orderdetail USING    ps_zsess23001
                                 CHANGING ps_orderdetail.


* 사원 이름 gt_orderdetail에 넣기.
  PERFORM set_empna USING ps_orderdetail-empid
                    CHANGING ps_orderdetail-empna.

* 제품 이름 gt_orderdetail에 넣기.
  PERFORM set_prdnm USING ps_orderdetail-prdid
                    CHANGING ps_orderdetail-prdnm.


* 제품 원가 gt_orderdetail에 넣기.
  PERFORM set_prdco USING    ps_orderdetail-prdid
                    CHANGING ps_orderdetail-prdco.

* 각 제품별 총합 대입하기.
  ps_orderdetail-sumal = ps_orderdetail-pdcnt * ps_orderdetail-prdco.
  APPEND ps_orderdetail TO pt_orderdetail. " table에 수정 내용 대입.

*alv에서 가져온 총 행들의 총 합을 구한 후, 스트럭쳐를 변경하고, db에 직접 반영하여, 구매오더의  총금액을 바꾸는 작업.
  PERFORM set_totlp_db   USING ps_orderdetail
                               pt_orderdetail
                         CHANGING  zsess24001-totlp.

*DB 반영하기 위해 field 들을 맞춰 주는 작업.
  MOVE-CORRESPONDING ps_orderdetail TO ls_save.

* DB에 insert
  INSERT ztess2301 FROM ls_save.
* Q. 지역변수처럼 form을 나가는 순간 사라질텐데 clear가 필요한가?
  CLEAR : ps_orderdetail, ps_zsess23001.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_prbdt_datum
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS23001_PRBDT
*&      <-- ZSESS23001_PRBDT
*&---------------------------------------------------------------------*
FORM set_prbdt_datum  USING    VALUE(p_prbdt) TYPE zsess23001-prbdt
                      CHANGING     arg_prbdt TYPE zsess23001-prbdt.

  CLEAR : p_prbdt.
* prbdt에 sy-datum 적용.
  p_prbdt = sy-datum.
* Screen prbdt에 변수 값 적용.
  arg_prbdt = p_prbdt.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_sumal_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> PS_ORDERDETAIL_PDCNT
*&      --> PS_ORDERDETAIL_PRDCO
*&      <-- PS_ORDERDETAIL_SUMAL
*&---------------------------------------------------------------------*
FORM set_sumal_data  USING    VALUE(ps_orderdetail)       TYPE zsess23001
                     CHANGING       pt_orderdetail        TYPE ztess23001_h.

  CLEAR : ps_orderdetail.

* 해당 오더코드에 속한 오더상세코드들 각각에 대한 원가 총합을 구하는 로직. + internal table에 반영.
  LOOP AT pt_orderdetail INTO ps_orderdetail.
    ps_orderdetail-sumal = ps_orderdetail-pdcnt * ps_orderdetail-prdco. "원가의 총합 = 제품 갯수  * 제품원가

    MODIFY pt_orderdetail FROM ps_orderdetail INDEX sy-tabix. "pt internal table에 수정된 원가의 총합을 반영하는 작업,
    CLEAR : ps_orderdetail-pdcnt, ps_orderdetail-prdco, ps_orderdetail-sumal.
    CLEAR : ps_orderdetail.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_TOTLP_DB
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> PS_ORDERDETAIL
*&      --> PT_ORDERDETAIL
*&      <-- ZTESS2401
*&---------------------------------------------------------------------*
FORM set_totlp_db  USING    VALUE(ps_orderdetail) TYPE zsess23001
                            VALUE(pt_orderdetail) TYPE ztess23001_h
                   CHANGING      zsess24001_totlp TYPE zsess24001-totlp.


  DATA : lv_cnt TYPE zsess23001-sumal.
  DATA : lv_prhid TYPE zsess23001-prhid.
  CLEAR : lv_cnt, lv_prhid, ps_orderdetail.

  LOOP AT pt_orderdetail INTO ps_orderdetail.
    lv_cnt += ps_orderdetail-sumal.
    CLEAR : ps_orderdetail.
  ENDLOOP.

  lv_prhid = zsess24001-prhid. "구매오더코드 값을 변수에 넣어 Screan반영에 사용.
  zsess24001_totlp = lv_cnt.

*구매오더 코드의 DB에  총금액 field의 값을 수정하는 작업.
  UPDATE ztess2401 SET totlp = lv_cnt WHERE prhid = lv_prhid.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_layout_orderdetail
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> PS_ZSESS23001
*&      <-- PS_ORDERDETAIL
*&---------------------------------------------------------------------*
FORM set_layout_orderdetail  USING    VALUE(ps_zsess23001) TYPE zsess23001
                             CHANGING       ps_orderdetail TYPE zsess23001.


  CLEAR : ps_orderdetail.

  ps_orderdetail-podid = ps_zsess23001-podid. " [C5SS] 구매오더상세코드
  ps_orderdetail-prhid = ps_zsess23001-prhid. " [C5SS] 구매오더코드
  ps_orderdetail-prdid = ps_zsess23001-prdid. " [C5SS] 제품코드
  ps_orderdetail-pdcnt = ps_zsess23001-pdcnt. " [C5SS] 제품수량
  ps_orderdetail-punit = ps_zsess23001-punit. " [C5SS] 수량단위
  ps_orderdetail-prbdt = ps_zsess23001-prbdt. " [C5SS] 구매요청일자
  ps_orderdetail-odchk = ps_zsess23001-odchk. " [C5SS] 담당자 승인 여부 {"T" : 승인 , "F" :  거절,  "N" : 승인 진행중}
  ps_orderdetail-empid = ps_zsess23001-empid. " [C5SS] 사원코드

ENDFORM.
*&---------------------------------------------------------------------*
*& Form Before_Each_PRHID
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM before_each_prhid .

*perform 처리 예정. => save하기 전에 채번하는 것이 원칙이다.
* 구매오더 코드 자동 채번 알고리즘. "모듈안에서 선언되는 변수는 global로 선언.

  DATA:
    lv_year(4)  TYPE i, "년수 ex) 2020 , 2021, 2022 지금년도.
    lv_char(8)  TYPE n, "뒤에 일련번호
    lv_full(14) TYPE c. "전체 코드 == 결과 코드

  DATA :
    lv_vdata(14) TYPE c, "(비교대상) DB에 있는 최고 구매코드
    lv_vnow(4)   TYPE c. "(비교대상) 지금 년도.

  DATA : ls_orderdb TYPE ztess2401,
         lv_data    TYPE ztess2401-prhid.
  CLEAR : gv_id, lv_year,  lv_char, lv_full, lv_vdata, lv_vnow, lv_data.

  SELECT SINGLE MAX( prhid )
  INTO  lv_data
  FROM ztess2401.

  MOVE sy-datum(4) TO lv_year.
  MOVE lv_data+6(8) TO lv_char. " 여기까지 채번의 최고숫자 입력 0000 0095.
  MOVE lv_data TO lv_vdata. " LV_VdATA = 최고 구매오더코드"

  lv_vnow = lv_year.

  IF lv_vdata+2(4) EQ lv_vnow. " 현제db yymmdd = 지금 yymmdd

    lv_char += 1.
    lv_full = 'PO' && lv_year && lv_char.
    gv_id = lv_full. " 자동 채번 번호 될 예정.

* Structure 필드 추가 + alv 출력을 위한 gt_order에 data 적재.
    PERFORM st_to_gtorder.

* 주문내역 DB에 저장 전처리 과정.
    PERFORM set_orderdb USING    zsess24003
                        CHANGING ls_orderdb.

* 주문내역 DB에 저장.
    INSERT ztess2401 FROM ls_orderdb.
    PERFORM message_prhid.


  ELSE.
    CLEAR : lv_char.
    lv_char += 1.
    lv_full = 'PO' && lv_year && lv_char.
    gv_id = lv_full. " 자동 채번 될 예정.

* Structure 필드 추가 + alv 출력을 위한 gt_order에 data 적재.
    PERFORM st_to_gtorder.

* 주문내역 DB에 저장 전처리 과정.
    PERFORM set_orderdb USING    zsess24003
                        CHANGING ls_orderdb.

* 주문내역 DB에 저장.
    INSERT ztess2401 FROM ls_orderdb.
    PERFORM message_prhid.


  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form Message_prhid
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM message_prhid .

  MESSAGE s000 WITH '저장이 완료 되었습니다!' && '당신의 구매오더코드는' && zsess24003-prhid && '입니다'.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form Before_Each_Pohid
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM before_each_pohid USING    VALUE(ps_zsess23001) TYPE zsess23001
                       CHANGING ps_zsess23001_podid TYPE zsess23001-podid
                                ps_zsess23001_prbdt TYPE zsess23001-prbdt.




*perform 처리 예정. => save하기 전에 채번하는 것이 원칙이다.
* 구매오더 코드 자동 채번 알고리즘. "모듈안에서 선언되는 변수는 global로 선언.
  CLEAR : zsess24003.

  DATA:
    lv_year(4)  TYPE i, "년수 ex) 2020 , 2021, 2022 지금년도.
    lv_char(8)  TYPE n, "뒤에 일련번호
    lv_full(14) TYPE c. "전체 코드 == 결과 코드

  DATA :
    lv_vdata(14) TYPE c, "(비교대상) DB에 있는 최고 구매코드
    lv_vnow(4)   TYPE c. "(비교대상) 지금 년도.


  DATA : lv_data TYPE ztess2301-podid.
  CLEAR : gv_id, lv_year,  lv_char, lv_full, lv_vdata, lv_vnow.

  SELECT SINGLE MAX( podid )
  INTO  lv_data
  FROM ztess2301.

  MOVE sy-datum(4) TO lv_year.
  MOVE lv_data+6(8) TO lv_char. " 여기까지 채번의 최고숫자 입력 0000 0095.

  MOVE lv_data TO lv_vdata. " LV_VdATA = 최고 구매오더코드"

  lv_vnow = lv_year.

  IF lv_vdata+2(4) EQ lv_vnow. " 현제db yymmdd = 지금 yymmdd

    lv_char += 1.
    lv_full = 'PD' && lv_year && lv_char.
    gv_id = lv_full. " 자동 채번 번호 될 예정.

    ps_zsess23001_podid = gv_id.

  ELSE.
    CLEAR : lv_char.
    lv_char += 1.
    lv_full = 'PD' && lv_year && lv_char.
    gv_id = lv_full. " 자동 채번 될 예정.
    ps_zsess23001_podid = gv_id.

  ENDIF.

  ps_zsess23001_prbdt = sy-datum.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_empna
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> PS_ORDERDETAIL_EMPID
*&      <-- PS_ORDERDETAIL_EMPNA
*&---------------------------------------------------------------------*
FORM set_empna  USING    VALUE(ps_orderdetail_empid) TYPE zsess23001-empid
                CHANGING       ps_orderdetail_empna  TYPE zsess23001-empna.

  DATA : lv_name  TYPE zsess24001-empna.
  CLEAR : lv_name.

  SELECT SINGLE empna
  INTO lv_name
  FROM ztess0301
  WHERE empid = ps_orderdetail_empid.

  ps_orderdetail_empna = lv_name. "ps_orderdetail의 사원 이름 field에 값 대입.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_prdnm
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> PS_ORDERDETAIL_PRDID
*&      <-- PS_ORDERDETAIL_PRDNM
*&---------------------------------------------------------------------*
FORM set_prdnm  USING    VALUE(ps_orderdetail_prdid) TYPE zsess23001-prdid
                CHANGING        ps_orderdetail_prdnm TYPE zsess23001-prdnm.

  DATA : lv_prdnm TYPE zsess23001-prdnm.
  CLEAR : lv_prdnm.

*제품 이름 gt_orderdetail에 넣기.
  SELECT SINGLE prdnm
    INTO lv_prdnm
    FROM ztess1601
    WHERE prdid = ps_orderdetail_prdid.
  ps_orderdetail_prdnm = lv_prdnm. "ps_orderdetail의 사원 이름 field에 값 대입.







ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_prdco
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> PS_ORDERDETAIL_PRDID
*&      <-- PS_ORDERDETAIL_PRDCO
*&---------------------------------------------------------------------*
FORM set_prdco  USING    ps_orderdetail_prdid
                CHANGING ps_orderdetail_prdco.

  DATA : lv_prdco TYPE zsess23001-prdco.
  CLEAR : lv_prdco.

  SELECT SINGLE prdco
    INTO lv_prdco
    FROM ztess1501
    WHERE prdid = ps_orderdetail_prdid
    AND valide = '99991231'.
  ps_orderdetail_prdco = lv_prdco. "ps_orderdetail의 제품 원가 field에 값 대입.



ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_empna_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24003_EMPID
*&      <-- ZSESS24003_EMPNA
*&---------------------------------------------------------------------*
FORM set_empna_data  USING    VALUE(pv_zsess24003_empid) TYPE zsess24003-empid
                     CHANGING       pv_zsess24003_empna  TYPE zsess24003-empna.

  DATA : lv_name  TYPE zsess24003-empna.
  CLEAR : lv_name.

  SELECT SINGLE empna
  INTO lv_name
  FROM ztess0301
  WHERE empid = pv_zsess24003_empid.

  pv_zsess24003_empna = lv_name. "ps_orderdetail의 사원 이름 field에 값 대입.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_pntnm_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24003_PNTID
*&      <-- ZSESS24003_PNTNM
*&---------------------------------------------------------------------*
FORM set_pntnm_data  USING    VALUE(pv_zsess24003_pntid) TYPE zsess24003-pntid
                     CHANGING       pv_zsess24003_pntnm  TYPE zsess24003-pntnm.


  DATA : lv_name  TYPE zsess24003-pntnm.
  CLEAR : lv_name.

  SELECT SINGLE pntnm
  INTO lv_name
  FROM ztess2501
  WHERE pntid = pv_zsess24003_pntid.

  pv_zsess24003_pntnm = lv_name. "ps_orderdetail의 사원 이름 field에 값 대입.



ENDFORM.
*&---------------------------------------------------------------------*
*& Form st_to_gtorder
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM st_to_gtorder .

*자동 채번된 값 zsess24003에 넣기
  zsess24003-prhid = gv_id.
* 사원 이름 zsess24003에  넣기.
  PERFORM set_empna_data USING    zsess24003-empid
                         CHANGING zsess24003-empna.

* 공장 이름 zsess24003에  넣기
  PERFORM set_pntnm_data USING    zsess24003-pntid
                         CHANGING zsess24003-pntnm.

*APPEND zsess24003 TO gt_order => Screen alv에 나오기 위해서.
  CLEAR : gs_order.
  MOVE-CORRESPONDING zsess24003 TO gs_order.
  APPEND gs_order TO gt_order.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_crtdm
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24003_CRTDM
*&      <-- ZSESS24003_CRTDM
*&---------------------------------------------------------------------*
FORM set_crtdm  USING    VALUE(p_zsess24003_crtdm) TYPE zsess24003-crtdm
                CHANGING       p_zsess24003_crtdm2  TYPE zsess24003-crtdm.

* 문서 생성일시 지금날짜 바로 적용.
  p_zsess24003_crtdm2 = sy-datum.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_orderdb
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24003
*&      <-- LS_ORDERDB
*&---------------------------------------------------------------------*
FORM set_orderdb  USING  VALUE(p_zsess24003) TYPE zsess24003
                  CHANGING     p_ls_orderdb TYPE ztess2401.

  CLEAR : p_ls_orderdb.
  MOVE-CORRESPONDING p_zsess24003 TO p_ls_orderdb.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form setting_layout
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      <-- GS_LAYO
*&---------------------------------------------------------------------*
FORM setting_layout  CHANGING ps_layo TYPE lvc_s_layo.

  ps_layo-zebra = 'X'.
  ps_layo-cwidth_opt = 'X'.
  ps_layo-stylefname = 'GS_CELLBTN'.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_prhid_lt_order
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> PV_PRHID_B
*&      --> PV_PRHID_E
*&      <-- LT_ORDER
*&---------------------------------------------------------------------*
FORM get_prhid_lt_order  USING    pv_prhid_b TYPE zsess24002-prhid_b
                                  pv_prhid_e TYPE zsess24002-prhid_e
                         CHANGING lt_order TYPE ztess2401_t.


  SELECT *
  FROM  ztess2401
  INTO CORRESPONDING FIELDS OF TABLE lt_order
  WHERE prhid BETWEEN pv_prhid_b AND pv_prhid_e.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_ltorder_plus
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LS_ORDER
*&      --> LT_ORDER
*&      --> PS_ORDER
*&      <-- PT_ORDER
*&---------------------------------------------------------------------*
FORM set_ltorder_plus  USING    ls_order TYPE ztess2401
                                lt_order TYPE ztess2401_t
                                ps_order TYPE zsess24001
                       CHANGING pt_order TYPE ztess24001_h.


  LOOP AT lt_order INTO ls_order.
* 구매오더 table(ZTESS2401) 위탁공장 table(ZTESS2501) 사원 table(ZTESS0301)'
* pt_order{'prhid', 'pntid', 'empid', 'title', 'prdat', 'crtdm', 'totlp', 'currc', 'odchk', 'pntnm' ,'empna'}
    SELECT SINGLE a~prhid a~pntid a~empid a~title a~prdat a~crtdm a~totlp a~currc a~odchk b~pntnm c~empna
      INTO CORRESPONDING FIELDS OF ps_order
      FROM ztess2401 AS a
      INNER JOIN ztess2501 AS b "구매오더 table 의 공장코드(pntid)를 통해 위탁공장의 이름(pntnm)을 가져온다.
      ON a~pntid = b~pntid
      INNER JOIN ztess0301 AS c "구매오더 table 의 사원코드(empid)를 통해 사원 이름(empid)을 가져온다.
      ON a~empid = c~empid
      WHERE prhid = ls_order-prhid. "sort 로도 사용 가능하다 (program에서 사용.)

    APPEND ps_order TO pt_order.
    CLEAR : ps_order, ls_order.
    SORT pt_order BY prhid .
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_prhid_lt_order_2
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> pv_pntid
*&      <-- LT_ORDER
*&---------------------------------------------------------------------*
FORM get_prhid_lt_order_2  USING    pv_pntid TYPE zsess24002-pntid
                           CHANGING lt_order TYPE ztess2401_t.

  SELECT *
    FROM  ztess2401
    INTO CORRESPONDING FIELDS OF TABLE lt_order
    WHERE pntid = pv_pntid.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_edited_before_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GS_ROW
*&      --> GT_ROWS
*&      --> GT_ORDER
*&      --> GS_ORDER
*&      <-- ZSESS24001
*&---------------------------------------------------------------------*
FORM set_edited_before_data  USING    VALUE(ps_row)   TYPE lvc_s_row
                                      VALUE(pt_rows)  TYPE lvc_t_row
                                      VALUE(pt_order) TYPE ztess24001_h
                                      VALUE(ps_order) TYPE zsess24004
                             CHANGING zsess24004 TYPE zsess24004.



  IF sy-subrc EQ 0.
    LOOP AT pt_rows INTO ps_row.

      READ TABLE pt_order INTO ps_order INDEX ps_row-index. "Screen 100의 검색버튼 작동 이후, ALV에서 선택한 값을 Screen 401에 미리 대입.

      zsess24004-prhid = ps_order-prhid. " 구매오더코드
      zsess24004-pntid = ps_order-pntid. " 공장코드
      zsess24004-pntnm = ps_order-pntnm. " 공장명
      zsess24004-empid = ps_order-empid. " 사원코드
      zsess24004-empna = ps_order-empna. " 사원 이름
      zsess24004-title = ps_order-title. " 제목
      zsess24004-prdat = ps_order-prdat. " 발주일자
      zsess24004-crtdm = ps_order-crtdm. " 문서생성일시
      zsess24004-totlp = ps_order-totlp. " 총구매금액
      zsess24004-currc = ps_order-currc. " 통화
      zsess24004-odchk = ps_order-odchk. " 담당자 승인 여부

    ENDLOOP.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_pntnm
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24004_PNTID
*&      <-- ZSESS24004_PNTNM
*&---------------------------------------------------------------------*
FORM set_pntnm  USING    VALUE(pv_pntid) TYPE zsess24004-pntid
                CHANGING pv_pntnm TYPE zsess24004-pntnm.


  SELECT SINGLE pntnm
    INTO pv_pntnm
    FROM ztess2501
    WHERE pntid = pv_pntid.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_empid
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24004_EMPID
*&      <-- ZSESS24004_EMPNA
*&---------------------------------------------------------------------*
FORM set_empid  USING    VALUE(pv_empid) TYPE zsess24004-empid
                CHANGING       pv_empna  TYPE zsess24004-empna.

  SELECT SINGLE empna
  INTO pv_empna
  FROM ztess0301
  WHERE empna = pv_empid.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_save_data_0401
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24004
*&      <-- GT_ORDER
*&      <-- ZTESS2401
*&---------------------------------------------------------------------*
FORM set_save_data_0401  USING    VALUE(zsess24004) TYPE zsess24004
                         CHANGING       gt_order    TYPE ztess24001_h.

  DATA : lt_data   TYPE TABLE OF zsess24001,
         ls_data   TYPE zsess24001,
         ls_dbdata TYPE ztess2401.

  CLEAR : lt_data, ls_data, ls_dbdata.

  MOVE-CORRESPONDING zsess24004 TO ls_data.

* internal table 수정
  MODIFY TABLE gt_order FROM ls_data.
  CLEAR : ls_data.

* layout의 structure의 내용을 db에 반영.
  MOVE-CORRESPONDING zsess24004 TO ls_dbdata.

*DB 반영. update 문으로 변경해보기.
  MODIFY ztess2401 FROM ls_dbdata.
  CLEAR : ls_dbdata.

  IF sy-subrc EQ 0.
    MESSAGE s002.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_prhid_data_0301
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24003_PRHID
*&      --> GS_ORDERDETAIL
*&      <-- GT_ORDERDETAIL
*&---------------------------------------------------------------------*
FORM set_prhid_data_0301  USING    VALUE(zsess24003_prhid) TYPE zsess24003-prhid
                                   VALUE(ps_orderdetail)   TYPE zsess23001
                          CHANGING pt_orderdetail TYPE ztess23001_h.

  SELECT a~podid "구매오더상세코드
         a~prhid
         a~prdid
         a~pdcnt
         a~punit
         a~prbdt
         a~odchk
         a~empid
         b~prdnm  "제품이름
         c~empna  "사원이름
         d~prdco  "제품 원가
   INTO CORRESPONDING FIELDS OF TABLE pt_orderdetail
   FROM ztess2301 AS a       " 구매오더 상세 TABLE
   INNER JOIN ztess1601 AS b " 제품 TABLE
   ON a~prdid = b~prdid      " 제품코드 비교 join 해서 '제품 이름'을 얻는 목적
   INNER JOIN ztess0301 AS c " 사원 TABLE
   ON a~empid = c~empid      " 사원코드 비교 join 해서 '사원 이름'을 얻는 목적
   INNER JOIN ztess1501 AS d " 제품 원가 이력 TABLE
   ON a~prdid = d~prdid     "제품코드가 같고 만료일자가 9999-12-31인 조건을 비교해서 '제품 원가를 얻는 목적'
   AND d~valide = '99991231'
   WHERE prhid = zsess24003_prhid "스크린의 오더코드와,  똑같은 오더코드를 가지고 있는 데이터를 DB에서가져와 주세요.
   ORDER BY podid. " 구매오더상세코드를 기준으로 오름차순 해주세요.

  " 해당 오더코드에 속한 오더상세코드들 각각에 대한 원가 총합을 구하는 로직 + internal table 업데이트,  NOT DB반영.
  PERFORM set_sumal_data USING    ps_orderdetail
                         CHANGING pt_orderdetail.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_orderdetail_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GS_ROW
*&      --> GT_ROWS
*&      --> GT_ORDERDETAIL
*&      --> GS_ORDERDETAIL
*&      <-- ZSESS23002
*&---------------------------------------------------------------------*
FORM set_orderdetail_data  USING    VALUE(gs_row)         TYPE lvc_s_row
                                    VALUE(gt_rows)        TYPE lvc_t_row
                                    VALUE(gt_orderdetail) TYPE ztess23001_h
                                    VALUE(gs_orderdetail) TYPE zsess23001
                           CHANGING zsess23002 TYPE zsess23002.


  LOOP AT gt_rows INTO gs_row.
    READ TABLE gt_orderdetail INTO gs_orderdetail INDEX gs_row-index.

    zsess23001-prhid = gs_orderdetail-prhid.
    zsess23001-empid = gs_orderdetail-empid.
    zsess23001-pdcnt = gs_orderdetail-pdcnt.
    zsess23001-podid = gs_orderdetail-podid.
    zsess23001-prbdt = gs_orderdetail-prbdt.
    zsess23001-prdid = gs_orderdetail-prdid.
    zsess23001-punit = gs_orderdetail-punit.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_selected_rows_200
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_selected_rows_200 .

  CLEAR : gt_rows, gs_row.

  CALL METHOD gcl_alv_grid200->get_selected_rows
    IMPORTING
      et_index_rows = gt_rows.


  IF gt_rows IS INITIAL.
    MESSAGE e000 WITH '행을 선택해주세요.'.
    RETURN.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_totlp_db_0401
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> PS_ORDERDETAIL
*&      --> PT_ORDERDETAIL
*&      <-- ZSESS24001_TOTLP
*&---------------------------------------------------------------------*
FORM set_totlp_db_0401  USING    VALUE(ps_orderdetail) TYPE zsess23001
                                 VALUE(pt_orderdetail) TYPE ztess23001_h
                        CHANGING p_zsess24001_totlp TYPE zsess24001-totlp.

  DATA : lv_cnt TYPE zsess23001-sumal.
  DATA : lv_prhid TYPE zsess23001-prhid.
  CLEAR : lv_cnt, lv_prhid, ps_orderdetail.

  LOOP AT pt_orderdetail INTO ps_orderdetail.
    lv_cnt += ps_orderdetail-sumal.
    CLEAR : ps_orderdetail.
  ENDLOOP.

  lv_prhid = zsess24001-prhid. "구매오더코드 값을 변수에 넣어 Screan반영에 사용.
  p_zsess24001_totlp = lv_cnt.

*구매오더 코드의 DB에  총금액 field의 값을 수정하는 작업.
  UPDATE ztess2401 SET totlp = lv_cnt WHERE prhid = lv_prhid.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_detail_ndata_400
*&---------------------------------------------------------------------*
*& text 구매오더상세코드 저장
*&---------------------------------------------------------------------*
*&      --> ZSESS23001
*&      --> GS_ORDERDETAIL
*&      <-- GT_ORDERDETAIL
*&---------------------------------------------------------------------*
FORM set_detail_ndata_400  USING    VALUE(ps_zsess23001)   TYPE zsess23001
                                    VALUE(ps_orderdetail) TYPE zsess23001
                           CHANGING        pt_orderdetail TYPE ztess23001_h
                                           zsess24001     TYPE zsess24001.


  DATA : ls_save TYPE ztess2301,
         lt_save TYPE TABLE OF ztess2301.

  DATA : ls_tmp TYPE zsess23001.

  CLEAR : ls_save.
  REFRESH : lt_save.

  ps_zsess23001-prbdt = sy-datum.

* Screen layout 에서 입력된 변수를 structure에 저장.
  PERFORM set_layout_orderdetail USING    ps_zsess23001
                                 CHANGING ps_orderdetail.


* 사원 이름 gt_orderdetail에 넣기.
  PERFORM set_empna USING ps_orderdetail-empid
                    CHANGING ps_orderdetail-empna.

* 제품 이름 gt_orderdetail에 넣기.
  PERFORM set_prdnm USING ps_orderdetail-prdid
                    CHANGING ps_orderdetail-prdnm.


* 제품 원가 gt_orderdetail에 넣기.
  PERFORM set_prdco USING    ps_orderdetail-prdid
                    CHANGING ps_orderdetail-prdco.

* 각 제품별 총합 대입하기.
  ps_orderdetail-sumal = ps_orderdetail-pdcnt * ps_orderdetail-prdco.

  READ TABLE pt_orderdetail INTO ls_tmp WITH KEY podid = ps_orderdetail-podid.
  ls_tmp = ps_orderdetail . " table에 수정 내용 대입.

  MODIFY TABLE pt_orderdetail FROM ls_tmp.


*alv에서 가져온 총 행들의 총 합을 구한 후, 스트럭쳐를 변경하고, db에 직접 반영하여, 구매오더의  총금액을 바꾸는 작업.
  PERFORM set_totlp_db_400   USING ps_orderdetail
                                   pt_orderdetail
                         CHANGING  zsess24001-totlp.

*DB 반영하기 위해 field 들을 맞춰 주는 작업.
  MOVE-CORRESPONDING ps_orderdetail TO ls_save.

* DB에 insert
  MODIFY ztess2301 FROM ls_save.
* Q. 지역변수처럼 form을 나가는 순간 사라질텐데 clear가 필요한가?

  IF sy-subrc EQ 0.
    CALL FUNCTION 'POPUP_TO_CONFIRM_LOSS_OF_DATA'
      EXPORTING
        textline1 = '저장하시겠습니까?'                 " first line of dialog box
*       textline2 = space            " second line of dialog box
        titel     = '저장여부 확인'                 " Title line of dialog box
*       start_column  = 25               " Start column of the dialog box
*       start_row = 6                " Start line of the dialog box
*       defaultoption = 'N'              " Cursor: Y: Yes button, N: No button
      IMPORTING
        answer    = gv_answer.                  " selected answer of user

  ENDIF.

  CHECK gv_answer NE 'N'.

  MESSAGE s002.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_pdname_400
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS23001_PRDID
*&      <-- ZSESS23001_PRDNM
*&---------------------------------------------------------------------*
FORM get_pdname_400  USING    VALUE(zsess23001_prdid) TYPE zsess23001-prdid
                     CHANGING zsess23001_prdnm.

  DATA : lv_pdname TYPE zsess23001-prdnm.
  CLEAR : lv_pdname.

  SELECT SINGLE prdnm
    INTO lv_pdname
    FROM ztess1601
    WHERE prdid = zsess23001_prdid.

  zsess23001_prdnm = lv_pdname.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_username_400
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS23001_EMPID
*&      <-- ZSESS23001_EMPNA
*&---------------------------------------------------------------------*
FORM get_username_400  USING    VALUE(zsess23001_empid) TYPE zsess23001-empid
                       CHANGING       zsess23001_empna  TYPE zsess23001-empna.

  DATA : lv_username TYPE zsess23001-empna.
  CLEAR : lv_username.

  SELECT SINGLE empna
    INTO lv_username
    FROM ztess0301
    WHERE empid = zsess23001_empid.

  zsess23001_empna = lv_username.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form f4_prdid
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM f4_prdid .

  DATA : BEGIN OF ls_value,
           prdid TYPE ztess1601-prdid,
           prdnm TYPE ztess1601-prdnm,
         END OF ls_value,

         lt_value LIKE TABLE OF ls_value.

  SELECT prdid prdnm
    INTO CORRESPONDING FIELDS OF TABLE lt_value
    FROM ztess1601
    WHERE prdid LIKE 'SSINSA%'.

  IF sy-subrc NE 0.

    MESSAGE s001.
    EXIT.

  ENDIF.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield        = 'PRDID'
      dynpprog        = sy-repid
      dynpnr          = sy-dynnr
      dynprofield     = 'ZSESS23001-PRDID'
      window_title    = '삽신사코드가 가지고 있는 스트럭쳐 가져오기'
      value_org       = 'S'
    TABLES
      value_tab       = lt_value
*     RETURN_TAB      =
    EXCEPTIONS
      parameter_error = 1
      no_values_found = 2
      OTHERS          = 3.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_totlp_db_400
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> PS_ORDERDETAIL
*&      --> PT_ORDERDETAIL
*&      <-- ZSESS24001_TOTLP
*&---------------------------------------------------------------------*
FORM set_totlp_db_400  USING    VALUE(ps_orderdetail)   TYPE zsess23001
                                VALUE(pt_orderdetail)   TYPE ztess23001_h
                       CHANGING       zsess24001_totlp  TYPE zsess24001-totlp.

  DATA : lv_cnt TYPE zsess23001-sumal.
  DATA : lv_prhid TYPE zsess23001-prhid.
  CLEAR : lv_cnt, lv_prhid, ps_orderdetail.

  LOOP AT pt_orderdetail INTO ps_orderdetail.
    lv_cnt += ps_orderdetail-sumal.
    CLEAR : ps_orderdetail.
  ENDLOOP.

  lv_prhid = zsess24001-prhid. "구매오더코드 값을 변수에 넣어 Screan반영에 사용.
  zsess24001_totlp = lv_cnt.

*구매오더 코드의 DB에  총금액 field의 값을 수정하는 작업.
  UPDATE ztess2401 SET totlp = lv_cnt WHERE prhid = lv_prhid.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form handle_double_click
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_COLUMN
*&      --> E_ROW
*&---------------------------------------------------------------------*
FORM handle_double_click  USING    p_column TYPE lvc_s_col
                                   p_row    TYPE lvc_s_row.


  CLEAR : gs_order.

  READ TABLE gt_order INTO gs_order INDEX p_row-index.

  zsess24001-prhid = gs_order-prhid. " 구매오더코드
  zsess24001-pntid = gs_order-pntid. " 공장코드
  zsess24001-pntnm = gs_order-pntnm. " 공장명
  zsess24001-empid = gs_order-empid. " 사원코드
  zsess24001-empna = gs_order-empna. " 사원 이름
  zsess24001-title = gs_order-title. " 제목
  zsess24001-prdat = gs_order-prdat. " 발주일자
  zsess24001-crtdm = gs_order-crtdm. " 문서생성일시
  zsess24001-totlp = gs_order-totlp. " 총구매금액
  zsess24001-currc = gs_order-currc. " 통화
  zsess24001-odchk = gs_order-odchk. " 담당자 승인 여부


  CALL SCREEN 0200.



ENDFORM.
*&---------------------------------------------------------------------*
*& Form f4_empid
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM f4_empid .


  DATA : BEGIN OF ls_value,
           empid TYPE ztess0301-empid,
           empna TYPE ztess0301-empna,
         END OF ls_value,

         lt_value LIKE TABLE OF ls_value.

  SELECT empid empna
    INTO CORRESPONDING FIELDS OF TABLE lt_value
    FROM ztess0301.

  IF sy-subrc NE 0.

    MESSAGE s001.
    EXIT.

  ENDIF.

  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield        = 'EMPID'
      dynpprog        = sy-repid
      dynpnr          = sy-dynnr
      dynprofield     = 'ZSESS23001-EMPID'
      window_title    = '사원코드로부터 사원 이름 가져오기'
      value_org       = 'S'
    TABLES
      value_tab       = lt_value
*     RETURN_TAB      =
    EXCEPTIONS
      parameter_error = 1
      no_values_found = 2
      OTHERS          = 3.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Module  VALIDATION  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE validation INPUT.

  IF zsess24002-prhid_b IS INITIAL.
    MESSAGE e000 WITH '구매오더코드의 시작 값을 입력해주세요.'.
    RETURN.

  ELSEIF zsess24002-prhid_e IS INITIAL.
    MESSAGE e000 WITH '구매오더코드의 마지막 값을 입력해주세요.'.
    RETURN.

  ELSEIF zsess24002-prhid_b GT zsess24002-prhid_e.
    MESSAGE e000 WITH '구매오더코드의 마지막 값이 시작 값보다 작습니다. 다시 입력해주세요.'.
    RETURN.

  ENDIF.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Form validation
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM validation .

  IF zsess24002-prhid_b IS INITIAL.
    MESSAGE e000 WITH '구매오더코드의 시작 값을 입력해주세요.'.
    EXIT.

  ELSEIF zsess24002-prhid_e IS INITIAL.
    MESSAGE e000 WITH '구매오더코드의 마지막 값을 입력해주세요.'.
    EXIT.

  ELSEIF zsess24002-prhid_b GT zsess24002-prhid_e.
    MESSAGE e000 WITH '구매오더코드의 마지막 값이 시작 값보다 작습니다. 다시 입력해주세요.'.
    EXIT.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_check_t
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_check_t .

  CALL METHOD gcl_alv_grid->get_selected_rows
    IMPORTING
      et_index_rows = gt_rows.


  IF gt_rows IS INITIAL.
    MESSAGE e000 WITH '행을 선택해주세요.'.
    RETURN.
  ENDIF.

  DATA : ls_data TYPE ztess2401.
  CLEAR : ls_data.

*test
  DATA : ls_input TYPE ztess2701.
  CLEAR : ls_input.

* 추후 여러행 선택시를 겨냥.
  LOOP AT gt_rows INTO gs_row.

    READ TABLE gt_order INTO gs_order INDEX gs_row-index.

    gs_order-odchk = 'T'.

    MOVE-CORRESPONDING gs_order TO ls_data.
    UPDATE ztess2401 FROM ls_data.
*    MOVE-CORRESPONDING gs_order to ls_input.
*    ls_input-impid = 'IM' && gs_order+2(12).
*    UPDATE ztess2701 FROM ls_input.
    CLEAR : ls_data.


    IF sy-subrc EQ 0.
      MESSAGE s000 WITH '승인 처리를 완료하였습니다.'.

    ENDIF.


  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_search_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_search_data .

*  IF gv_test = 'X'.
*
*    DATA : lt_order TYPE TABLE OF ztess2401,
*           ls_order LIKE LINE OF lt_order.
*
*    PERFORM get_prhid_lt_order2 USING zsess24002-prhid_b
*                                      zsess24002-prhid_e
*                               CHANGING lt_order.
*
** 조건에 맞는 구매오더코드의 추가 정보들을 JOIN 하는 로직.
** 구매오더 table(ZTESS2401) 위탁공장 table(ZTESS2501) 사원 table(ZTESS0301)'
*    PERFORM set_ltorder_plus2  USING   ls_order
*                                       lt_order
*                                       gs_order
*                              CHANGING gt_order.
*    PERFORM set_icon_odchk.
*
*  ELSE.
*
*    PERFORM get_prhid_lt_order3 USING     zsess24002-prhid_b
*                                          zsess24002-prhid_e
*                                CHANGING  gt_order.
*
** 조건에 맞는 구매오더코드의 추가 정보들을 JOIN 하는 로직.
** 구매오더 table(ZTESS2401) 위탁공장 table(ZTESS2501) 사원 table(ZTESS0301)'
*    PERFORM set_ltorder_plus2  USING   ls_order
*                                       lt_order
*                                       gs_order
*                              CHANGING gt_order.
*
*
*    PERFORM set_icon_odchk.
*
*  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_prhid_lt_order2
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24002_PRHID_B
*&      --> ZSESS24002_PRHID_E
*&      <-- LT_ORDER
*&---------------------------------------------------------------------*
FORM get_prhid_lt_order2  USING    VALUE(zsess24002_prhid_b)
                                   VALUE(zsess24002_prhid_e)
                          CHANGING lt_order.

  SELECT *
  FROM ztess2401
  INTO CORRESPONDING FIELDS OF TABLE gt_order
  WHERE prhid BETWEEN zsess24002_prhid_b AND zsess24002_prhid_e
    AND odchk = 'N'
  ORDER BY prhid.



ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_ltorder_plus2
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LS_ORDER
*&      --> LT_ORDER
*&      --> GS_ORDER
*&      <-- GT_ORDER
*&---------------------------------------------------------------------*
FORM set_ltorder_plus2  USING    VALUE(ls_order) TYPE ztess2401
                                 VALUE(lt_order) TYPE ztess2401_t
                                 VALUE(gs_order) TYPE zsess24001
                        CHANGING       gt_order  TYPE ztess24001_h.


  LOOP AT lt_order INTO ls_order.
* 구매오더 table(ZTESS2401) 위탁공장 table(ZTESS2501) 사원 table(ZTESS0301)'
* pt_order{'prhid', 'pntid', 'empid', 'title', 'prdat', 'crtdm', 'totlp', 'currc', 'odchk', 'pntnm' ,'empna'}
    SELECT SINGLE a~prhid a~pntid a~empid a~title a~prdat a~crtdm a~totlp a~currc a~odchk b~pntnm c~empna
      INTO CORRESPONDING FIELDS OF gs_order
      FROM ztess2401 AS a
      INNER JOIN ztess2501 AS b "구매오더 table 의 공장코드(pntid)를 통해 위탁공장의 이름(pntnm)을 가져온다.
      ON a~pntid = b~pntid
      INNER JOIN ztess0301 AS c "구매오더 table 의 사원코드(empid)를 통해 사원 이름(empid)을 가져온다.
      ON a~empid = c~empid
      WHERE prhid = ls_order-prhid. "sort 로도 사용 가능하다 (program에서 사용.)

    APPEND gs_order TO gt_order.
    CLEAR : gs_order, ls_order.
    SORT gt_order BY prhid .
  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_icon_odchk
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_icon_odchk .

  LOOP AT gt_order INTO gs_order.

    CASE gs_order-odchk.
      WHEN 'N'.                         " 결재요청 대기중
        gs_order-icond = icon_yellow_light.
        MODIFY gt_order FROM gs_order.

      WHEN 'T'.                         " 결재 요청 승인
        gs_order-icond = icon_green_light.
        MODIFY gt_order FROM gs_order.

      WHEN 'F'.                         " 결재 요청 거절
        gs_order-icond = icon_red_light.
        MODIFY gt_order FROM gs_order.
      WHEN OTHERS.
        gs_order-icond = icon_locked.
        MODIFY gt_order FROM gs_order.
    ENDCASE.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_prhid_lt_order3
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ZSESS24002_PRHID_B
*&      --> ZSESS24002_PRHID_E
*&      <-- LT_ORDER
*&---------------------------------------------------------------------*
FORM get_prhid_lt_order3  USING    VALUE(zsess24002_prhid_b)
                                   VALUE(zsess24002_prhid_e)
                          CHANGING lt_order.


*  SELECT *
*  FROM ztess2401
*  INTO CORRESPONDING FIELDS OF TABLE lt_order
*  WHERE prhid BETWEEN zsess24002_prhid_b AND zsess24002_prhid_e
*  ORDER BY prhid.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form beforeEach_0200
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM beforeeach_0200 .

  gv_uname = sy-uname.
  gv_uzeit = sy-uzeit.


  IF gv_uname = 'KD-E-07'.
    gv_uname = '이운형 고문'.

  ELSE.
    gv_uname = sy-ucomm.
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form build_node_table
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> NODE_TABLE
*&---------------------------------------------------------------------*
FORM build_node_table  USING    node_table TYPE node_table_type.

  DATA : node LIKE mtreesnode.

  CLEAR node.
  node-node_key = 'Root'.
  node-isfolder = 'X'.      " a folder.
  node-text = '구매오더리스트'.
  APPEND node TO node_table.

  CLEAR node.
  node-node_key = 'Child1'.
  node-relatkey = 'Root'.
  node-isfolder = 'X'.
  node-text = '공장명'.
  node-expander = 'X' .
  APPEND node TO node_table.

  CLEAR node.
  node-node_key = 'P01'.
  node-relatkey = 'Child1'.
  node-n_image = '@10@'.
  node-style = cl_gui_simple_tree=>style_emphasized.
  node-text = 'P01'.
  APPEND node TO node_table.


  CLEAR node.
  node-node_key = 'P02'.
  node-relatkey = 'Child1'.
  node-n_image = '@10@'.
  node-text = 'P02'.
  APPEND node TO node_table.

  CLEAR node.
  node-node_key = 'P03'.
  node-relatkey = 'Child1'.
  node-n_image = '@10@'.
  node-text = 'P03'.
  APPEND node TO node_table.

  CLEAR node.
  node-node_key = 'P04'.
  node-relatkey = 'Child1'.
  node-n_image = '@10@'.
  node-text = 'P04'.
  APPEND node TO node_table.

  CLEAR node.
  node-node_key = 'P05'.
  node-relatkey = 'Child1'.
  node-n_image = '@10@'.
  node-text = 'P05'.
  APPEND node TO node_table.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form refresh_grid
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_grid .

  DATA : l_scroll TYPE lvc_s_stbl.
  l_scroll-row = 'X'.
  l_scroll-col = 'X'.
  CALL METHOD grid1->refresh_table_display
    EXPORTING
      i_soft_refresh = ''
      is_stable      = l_scroll.

ENDFORM.
FORM setting_layout_tree .
*- General display options
  gs_layout-cwidth_opt = 'X'.
* TITLE BAR
  gs_layout-grid_title = '보고싶은 구매오더번호를 클릭하세요'.
* Selection modes for SEL_MODE
  gs_layout-sel_mode = 'D'.
* Grid pattern
  gs_layout-zebra      = 'X'.

  IF gt_fcat2 IS INITIAL.

    PERFORM set_fcat2_1 USING :      gs_fcat2-fieldname
                                     gs_fcat2-coltext
                                     gs_fcat2-ref_table
                                     gs_fcat2-ref_field
                                     gs_fcat2-edit
                                     gs_fcat2-no_out
                                     gs_fcat2-icon
                                     gs_fcat2-col_pos
                                     gs_fcat2-currency
                                     gs_fcat2-emphasize
                          CHANGING : gt_fcat2.



  ENDIF.



ENDFORM.                    " setting_layout
*&---------------------------------------------------------------------*
*&      Form  setting_toolbar
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GS_TOOLBAR  text
*----------------------------------------------------------------------*
FORM setting_toolbar.
  DATA: l_exclude TYPE ui_func.

  l_exclude = cl_gui_alv_grid=>mc_fc_save_variant.
  APPEND l_exclude TO gs_toolbar.

  l_exclude = cl_gui_alv_grid=>mc_fc_maintain_variant.
  APPEND l_exclude TO gs_toolbar.

ENDFORM.                    " setting_toolbar
*&---------------------------------------------------------------------*
*&      Form  setting_sort
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM setting_sort .

  DATA : ls_sort TYPE lvc_s_sort.

  ls_sort-spos = '1'.
  ls_sort-fieldname = 'PNTID'.
  ls_sort-up = 'X'.
  ls_sort-subtot = 'X'.
  APPEND ls_sort TO gt_sort.




ENDFORM.                    " setting_sort
*&---------------------------------------------------------------------*
*&      Form  setting_event
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM setting_event .
  CREATE OBJECT event_receiver.
*  SET HANDLER event_receiver->handle_double_click  FOR grid1.
  SET HANDLER event_receiver->handle_toolbar       FOR grid1.
  SET HANDLER event_receiver->handle_command       FOR grid1.

  "EVENT PAGE 생성. TODO Error"
  CREATE OBJECT gcl_handler.
  SET HANDLER : gcl_handler->handle_double_click FOR grid1.


ENDFORM.                    " setting_event
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Form set_beforeEach_0100
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_beforeeach_0100 .

  gv_uname = sy-uname.

  IF gv_uname  = 'KD-E-07'.

    gv_uname = '이운형 사장'.

  ENDIF.

  PERFORM set_input_27.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_check_F
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_check_f .

  CALL METHOD gcl_alv_grid->get_selected_rows
    IMPORTING
      et_index_rows = gt_rows.


  IF gt_rows IS INITIAL.
    MESSAGE e000 WITH '행을 선택해주세요.'.
    RETURN.
  ENDIF.

  DATA : ls_data TYPE ztess2401.
  CLEAR : ls_data.

* 추후 여러행 선택시를 겨냥.
  LOOP AT gt_rows INTO gs_row.

    READ TABLE gt_order INTO gs_order INDEX gs_row-index.

    gs_order-odchk = 'F'.

    MOVE-CORRESPONDING gs_order TO ls_data.

    UPDATE ztess2401 FROM ls_data.
    CLEAR : ls_data.

  ENDLOOP.

  IF sy-subrc EQ 0.
    MESSAGE s000 WITH '취소 처리를 완료하였습니다.'.

  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_input_27
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_input_27 .


  LOOP AT gt_order INTO gs_order.
    CLEAR : gs_input.

    IF gs_order-odchk EQ 'T'.
      MOVE-CORRESPONDING gs_order TO gs_input.
      gs_input-impid = 'IM' && gs_order+2(12).
      gs_input-wflag = 'ISTBY'.
      gs_input-idate = gs_order-prdat.
      INSERT  ztess2701 FROM gs_input.


    ENDIF.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_fcat2_1
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> GS_FCAT200_FIELDNAME
*&      --> GS_FCAT200_COLTEXT
*&      --> GS_FCAT200_REF_TABLE
*&      --> GS_FCAT200_REF_FIELD
*&      --> GS_FCAT200_EDIT
*&      --> GS_FCAT200_NO_OUT
*&      --> GS_FCAT200_ICON
*&      --> GS_FCAT200_COL_POS
*&      --> GS_FCAT200_CURRENCY
*&      <-- GT_FCAT200
*&---------------------------------------------------------------------*
FORM set_fcat2_1  USING    pv_fieldname  TYPE lvc_s_fcat-fieldname
                           pv_coltext    TYPE lvc_s_fcat-coltext
                           pv_ref_table  TYPE lvc_s_fcat-ref_table
                           pv_ref_field  TYPE lvc_s_fcat-ref_field
                           pv_edit       TYPE lvc_s_fcat-edit
                           pv_no_out     TYPE lvc_s_fcat-no_out
                           pv_icon       TYPE lvc_s_fcat-icon
                           pv_col_pos    TYPE lvc_s_fcat-col_pos
                           pv_currency   TYPE lvc_s_fcat-currency
                           pv_emp        TYPE lvc_s_fcat-emphasize
                  CHANGING pt_fcat       TYPE lvc_t_fcat.



* 구매오더상세코드
  pv_fieldname = 'PRHID'.
  pv_coltext   = ' '.
  pv_ref_table = 'ZTESS2301'.
  pv_ref_field = 'PRHID'.
  pv_edit      = ' '.
  pv_no_out    = ' '.
  pv_emp       = 'X'.
  APPEND gs_fcat2 TO pt_fcat.
  CLEAR : gs_fcat.

ENDFORM.




                                 
